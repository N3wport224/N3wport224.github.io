<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full font-sans antialiased text-gray-800">

    <section id="auth-section" class="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-50">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-center text-indigo-600">My Finance Tracker</h1>
            <div id="login-form">
                <h2 class="text-xl font-semibold text-center mb-4">Login</h2>
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-200">
                    <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-200">
                    <button id="login-btn" class="w-full py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Login</button>
                </div>
                <p id="login-message-box" class="mt-4 text-center text-sm hidden"></p>
                <button id="show-signup-btn" class="w-full mt-4 py-2 text-indigo-600 border border-indigo-600 rounded-md hover:bg-indigo-50">Don't have an account? Sign up</button>
            </div>
            <div id="signup-form" class="hidden">
                <h2 class="text-xl font-semibold text-center mb-4">Sign Up</h2>
                <div class="space-y-4">
                    <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-200">
                    <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-200">
                    <button id="create-account-btn" class="w-full py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Create Account</button>
                </div>
                <p id="signup-message-box" class="mt-4 text-center text-sm hidden"></p>
                <button id="back-to-login-btn" class="w-full mt-4 py-2 text-indigo-600 border border-indigo-600 rounded-md hover:bg-indigo-50">Back to Login</button>
            </div>
        </div>
    </section>

    <section id="tracker-section" class="hidden min-h-screen p-4 bg-gray-100 md:p-8">
        <header class="flex flex-col items-center justify-between p-4 mb-6 bg-white rounded-xl shadow-md sm:flex-row">
            <div class="flex flex-col sm:flex-row sm:items-center">
                <h1 class="text-2xl font-bold">Finance Tracker</h1>
                <span class="mt-1 ml-0 text-sm text-gray-500 sm:ml-4 sm:mt-0">User ID: <span id="user-id" class="font-mono"></span></span>
            </div>
            <button id="logout-btn" class="w-full mt-4 py-2 text-sm text-white bg-red-500 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 sm:w-auto sm:px-4 sm:mt-0">Logout</button>
        </header>

        <nav class="flex justify-around p-2 mb-6 space-x-2 bg-white rounded-xl shadow-sm md:justify-start">
            <button data-page="tracker" class="tab-btn px-4 py-2 font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Tracker</button>
            <button data-page="snowball" class="tab-btn px-4 py-2 font-medium text-gray-800 bg-gray-200 rounded-lg hover:bg-gray-300">Debt Snowball</button>
            <button data-page="calendar" class="tab-btn px-4 py-2 font-medium text-gray-800 bg-gray-200 rounded-lg hover:bg-gray-300">Payday Calendar</button>
        </nav>

        <div id="tracker-page" class="page-container">
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
                <div class="p-6 bg-white rounded-xl shadow-md lg:col-span-2 lg:row-span-2">
                    <h2 class="mb-4 text-xl font-semibold">Summary</h2>
                    <div class="grid grid-cols-2 gap-4 text-center md:grid-cols-4">
                        <div class="flex flex-col items-center p-4 bg-green-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-500">Income</span>
                            <span id="total-income" class="text-xl font-bold text-green-700">$0.00</span>
                        </div>
                        <div class="flex flex-col items-center p-4 bg-red-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-500">Expenses</span>
                            <span id="total-expenses" class="text-xl font-bold text-red-700">$0.00</span>
                        </div>
                        <div class="flex flex-col items-center p-4 bg-purple-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-500">Debt</span>
                            <span id="total-debt" class="text-xl font-bold text-purple-700">$0.00</span>
                        </div>
                        <div class="flex flex-col items-center p-4 bg-gray-200 rounded-lg">
                            <span class="text-sm font-medium text-gray-500">Balance</span>
                            <span id="total-balance" class="text-xl font-bold text-green-700">$0.00</span>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md lg:col-span-1">
                    <h2 id="form-title" class="mb-4 text-xl font-semibold">Add New Transaction</h2>
                    <form id="transaction-form" class="space-y-4">
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                            <input type="text" id="description" placeholder="e.g. Groceries" required class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200">
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="number" id="amount" placeholder="e.g. 50.00" step="0.01" required class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200">
                        </div>
                        <div>
                            <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                            <select id="type" required class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200">
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                                <option value="debt">Debt</option>
                            </select>
                        </div>

                        <div id="debt-fields-container" class="hidden">
                            <div>
                                <label for="interest-rate" class="block text-sm font-medium text-gray-700">Interest Rate (%)</label>
                                <input type="number" id="interest-rate" placeholder="e.g. 5.5" step="0.01" class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200">
                            </div>
                            <div>
                                <label for="min-payment" class="block text-sm font-medium text-gray-700">Minimum Monthly Payment ($)</label>
                                <input type="number" id="min-payment" placeholder="e.g. 100" step="0.01" class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200">
                            </div>
                        </div>

                        <div>
                            <label for="recurrence" class="block text-sm font-medium text-gray-700">Recurrence</label>
                            <select id="recurrence" class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200">
                                <option value="none">None</option>
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        
                        <div id="recurring-income-fields" class="hidden">
                            <div id="weekly-days-container" class="space-y-2 hidden">
                                <span class="block text-sm font-medium text-gray-700">Day(s) of the week:</span>
                                <div class="flex flex-wrap gap-2">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="day-of-week" value="sunday" class="text-indigo-600 rounded-full">
                                        <span class="text-sm">Sun</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="day-of-week" value="monday" class="text-indigo-600 rounded-full">
                                        <span class="text-sm">Mon</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="day-of-week" value="tuesday" class="text-indigo-600 rounded-full">
                                        <span class="text-sm">Tue</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="day-of-week" value="wednesday" class="text-indigo-600 rounded-full">
                                        <span class="text-sm">Wed</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="day-of-week" value="thursday" class="text-indigo-600 rounded-full">
                                        <span class="text-sm">Thu</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="day-of-week" value="friday" class="text-indigo-600 rounded-full">
                                        <span class="text-sm">Fri</span>
                                    </label>
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" name="day-of-week" value="saturday" class="text-indigo-600 rounded-full">
                                        <span class="text-sm">Sat</span>
                                    </label>
                                </div>
                            </div>
                            <div id="monthly-day-container" class="hidden">
                                <label for="monthly-day" class="block text-sm font-medium text-gray-700">Day of the month:</label>
                                <input type="number" id="monthly-day" min="1" max="31" placeholder="e.g. 15" class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200">
                            </div>
                            <div>
                                <label for="next-pay-date" class="block text-sm font-medium text-gray-700">Next Pay Date</label>
                                <input type="date" id="next-pay-date" class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200">
                            </div>
                            <div>
                                <label for="timezone-select" class="block text-sm font-medium text-gray-700">Time Zone</label>
                                <select id="timezone-select" class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200"></select>
                            </div>
                        </div>

                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">Notes (optional)</label>
                            <textarea id="notes" rows="2" placeholder="e.g. Rent payment for July" class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200"></textarea>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button type="submit" id="save-transaction-btn" class="flex-1 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Add Transaction</button>
                            <button type="button" id="delete-transaction-btn" class="flex-1 py-2 text-white bg-red-500 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 hidden">Delete</button>
                            <button type="button" id="cancel-edit-btn" class="flex-1 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 hidden">Cancel</button>
                        </div>
                        <p id="message-box" class="text-center text-sm hidden"></p>
                    </form>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md md:col-span-2 lg:col-span-3">
                    <h2 class="mb-4 text-xl font-semibold">Transactions</h2>
                    <div id="transactions-list" class="space-y-3">
                        </div>
                </div>
            </div>
        </div>

        <div id="snowball-page" class="page-container hidden">
            <div class="p-6 bg-white rounded-xl shadow-md">
                <h2 class="mb-4 text-xl font-semibold">Debt Snowball Calculator</h2>
                <p class="mb-4 text-gray-600">The debt snowball method is a strategy to pay off debt by prioritizing the smallest debt first, regardless of interest rate. Once the smallest debt is paid off, you "snowball" its payment amount to the next smallest debt.</p>
                <div class="space-y-4">
                    <div>
                        <label for="extra-payment" class="block text-sm font-medium text-gray-700">Extra Monthly Payment ($)</label>
                        <input type="number" id="extra-payment" placeholder="e.g. 100" class="w-full px-3 py-2 mt-1 border rounded-md focus:ring focus:ring-indigo-200">
                    </div>
                    <div class="flex space-x-2">
                        <button id="calculate-snowball-btn" class="flex-1 py-2 text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Calculate Snowball</button>
                        <button id="download-snowball-btn" class="flex-1 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Download Plan</button>
                    </div>
                </div>
                <div id="snowball-results" class="mt-6 space-y-4">
                    </div>
            </div>
        </div>

        <div id="calendar-page" class="page-container hidden">
            <div class="p-6 bg-white rounded-xl shadow-md">
                <h2 class="mb-4 text-xl font-semibold">Payday Calendar</h2>
                <div class="flex items-center justify-between">
                    <button id="prev-month-btn" class="p-2 text-gray-600 rounded-full hover:bg-gray-200">&lt;</button>
                    <h3 id="current-month-year" class="text-lg font-semibold"></h3>
                    <button id="next-month-btn" class="p-2 text-gray-600 rounded-full hover:bg-gray-200">&gt;</button>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 p-4 mt-4 text-sm font-medium text-center bg-gray-50 rounded-lg">
                    </div>
                <div class="p-4 mt-6 bg-gray-50 rounded-xl">
                    <h4 class="mb-2 text-lg font-semibold">Upcoming Paydays</h4>
                    <ul id="upcoming-paydays-list" class="space-y-1 text-sm list-disc list-inside">
                        </ul>
                </div>
            </div>
        </div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
              apiKey: "AIzaSyDAMs4fq-aM3YJuBux2v4XRirGXGtW_bt4",
              authDomain: "financial-tracker-705f1.firebaseapp.com",
              projectId: "financial-tracker-705f1",
              storageBucket: "financial-tracker-705f1.firebasestorage.app",
              messagingSenderId: "284361332931",
              appId: "1:284361332931:web:b287647d246eb70a49aa76",
              measurementId: "G-VLF5B7LN6B"
            };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;

        let userId = null;
        let unsubscribeFromTransactions = null;

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const trackerSection = document.getElementById('tracker-section');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const showSignupBtn = document.getElementById('show-signup-btn');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const createAccountBtn = document.getElementById('create-account-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginMessageBox = document.getElementById('login-message-box');
        const signupMessageBox = document.getElementById('signup-message-box');
        const userIdEl = document.getElementById('user-id');

        const transactionsListEl = document.getElementById('transactions-list');
        const totalBalanceEl = document.getElementById('total-balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const totalDebtEl = document.getElementById('total-debt');

        const transactionForm = document.getElementById('transaction-form');
        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const typeSelect = document.getElementById('type');
        const recurrenceSelect = document.getElementById('recurrence');
        const notesInput = document.getElementById('notes');
        const saveTransactionBtn = document.getElementById('save-transaction-btn');
        const deleteTransactionBtn = document.getElementById('delete-transaction-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const messageBoxEl = document.getElementById('message-box');
        const formTitle = document.getElementById('form-title');

        const debtFieldsContainer = document.getElementById('debt-fields-container');
        const interestRateInput = document.getElementById('interest-rate');
        const minPaymentInput = document.getElementById('min-payment');

        const calculateSnowballBtn = document.getElementById('calculate-snowball-btn');
        const extraPaymentInput = document.getElementById('extra-payment');
        const snowballResultsEl = document.getElementById('snowball-results');
        const downloadSnowballBtn = document.getElementById('download-snowball-btn');

        const recurringIncomeFields = document.getElementById('recurring-income-fields');
        const weeklyDaysContainer = document.getElementById('weekly-days-container');
        const monthlyDayContainer = document.getElementById('monthly-day-container');
        const nextPayDateInput = document.getElementById('next-pay-date');
        const daysOfWeekCheckboxes = document.querySelectorAll('input[name="day-of-week"]');
        const monthlyDayInput = document.getElementById('monthly-day');
        const timezoneSelect = document.getElementById('timezone-select');

        const calendarGridEl = document.getElementById('calendar-grid');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const upcomingPaydaysListEl = document.getElementById('upcoming-paydays-list');
        let currentCalendarDate = new Date();

        const tabButtons = document.querySelectorAll('.tab-btn');
        const pageContainers = document.querySelectorAll('.page-container');

        let transactions = [];
        let editingTransactionId = null;

        // --- AUTHENTICATION FUNCTIONS ---
        const showSignupForm = () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            loginMessageBox.classList.add('hidden');
        };

        const showLoginForm = () => {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            signupMessageBox.classList.add('hidden');
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Signed in successfully!", false, loginMessageBox);
            } catch (error) {
                showMessage("Sign in failed. Check your credentials.", true, loginMessageBox);
                console.error("Sign in error:", error);
            }
        };

        const handleSignup = async (e) => {
            e.preventDefault();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Account created successfully! Please sign in.", false, signupMessageBox);
                showLoginForm();
            } catch (error) {
                showMessage(error.message || "Sign up failed. Please try again.", true, signupMessageBox);
                console.error("Sign up error:", error);
            }
        };
        
        // --- FINANCIAL TRACKER FUNCTIONS ---
        const toggleDebtFields = () => {
            if (typeSelect.value === 'debt') {
                debtFieldsContainer.classList.remove('hidden');
            } else {
                debtFieldsContainer.classList.add('hidden');
                interestRateInput.value = '';
                minPaymentInput.value = '';
            }
        };

        const toggleRecurrenceFields = () => {
            const type = typeSelect.value;
            const recurrence = recurrenceSelect.value;
            
            recurringIncomeFields.classList.add('hidden');
            weeklyDaysContainer.classList.add('hidden');
            monthlyDayContainer.classList.add('hidden');
            nextPayDateInput.closest('div').classList.add('hidden');
            timezoneSelect.closest('div').classList.add('hidden');

            if (type === 'income' && recurrence !== 'none') {
                recurringIncomeFields.classList.remove('hidden');
                nextPayDateInput.closest('div').classList.remove('hidden');
                timezoneSelect.closest('div').classList.remove('hidden');

                if (recurrence === 'weekly' || recurrence === 'biweekly') {
                    weeklyDaysContainer.classList.remove('hidden');
                } else if (recurrence === 'monthly') {
                    monthlyDayContainer.classList.remove('hidden');
                }
            }
        };

        const resetForm = () => {
            transactionForm.reset();
            formTitle.textContent = 'Add New Transaction';
            saveTransactionBtn.textContent = 'Add Transaction';
            deleteTransactionBtn.classList.add('hidden');
            cancelEditBtn.classList.add('hidden');
            editingTransactionId = null;
            toggleDebtFields();
            toggleRecurrenceFields();
        };

        const showMessage = (msg, isError = false, targetEl) => {
            targetEl.textContent = msg;
            targetEl.classList.remove('hidden');
            targetEl.classList.toggle('text-red-500', isError);
            targetEl.classList.toggle('text-green-500', !isError);
            setTimeout(() => {
                targetEl.classList.add('hidden');
            }, 5000);
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(amount);
        };

        const updateSummary = () => {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalDebt = transactions
                .filter(t => t.type === 'debt')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalBalance = totalIncome - totalExpenses - totalDebt;

            totalBalanceEl.textContent = formatCurrency(totalBalance);
            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpensesEl.textContent = formatCurrency(totalExpenses);
            totalDebtEl.textContent = formatCurrency(totalDebt);

            if (totalBalance < 0) {
                totalBalanceEl.classList.remove('text-green-700');
                totalBalanceEl.classList.add('text-red-700');
            } else {
                totalBalanceEl.classList.remove('text-red-700');
                totalBalanceEl.classList.add('text-green-700');
            }
        };

        const renderTransactions = () => {
            transactionsListEl.innerHTML = '';
            if (transactions.length === 0) {
                transactionsListEl.innerHTML = '<p class="text-center text-gray-500">No transactions added yet.</p>';
                return;
            }

            const sortedTransactions = transactions.sort((a, b) => {
                const dateA = a.timestamp ? a.timestamp.toDate() : new Date();
                const dateB = b.timestamp ? b.timestamp.toDate() : new Date();
                return dateB - dateA;
            });

            sortedTransactions.forEach((transaction) => {
                let bgColor, textColor, sign;

                if (transaction.type === 'income') {
                    bgColor = 'bg-green-50';
                    textColor = 'text-green-600';
                    sign = '+';
                } else if (transaction.type === 'expense') {
                    bgColor = 'bg-red-50';
                    textColor = 'text-red-600';
                    sign = '-';
                } else if (transaction.type === 'debt') {
                    bgColor = 'bg-purple-50';
                    textColor = 'text-purple-600';
                    sign = '-';
                }

                const transactionEl = document.createElement('div');
                transactionEl.className = `flex justify-between items-center p-4 rounded-xl shadow-sm transition-all duration-300 ${bgColor} hover:bg-gray-100 cursor-pointer`;
                transactionEl.dataset.id = transaction.id;
                transactionEl.addEventListener('click', () => editTransaction(transaction));

                let recurrenceText = '';
                if (transaction.recurrence && transaction.recurrence !== 'none') {
                    recurrenceText = `<span class="text-xs text-gray-500 ml-2">(${transaction.recurrence})</span>`;
                }

                let notesText = '';
                if (transaction.notes) {
                    notesText = `<p class="text-xs text-gray-400 mt-1">Notes: ${transaction.notes}</p>`;
                }
                
                let debtDetails = '';
                if (transaction.type === 'debt') {
                    debtDetails = `<div class="text-xs text-gray-400 mt-1">
                        ${transaction.interestRate ? `Interest: ${transaction.interestRate}%` : ''}
                        ${transaction.interestRate && transaction.minPayment ? ' | ' : ''}
                        ${transaction.minPayment ? `Min. Pmt: $${transaction.minPayment.toFixed(2)}` : ''}
                    </div>`;
                }
                
                transactionEl.innerHTML = `
                    <div class="flex flex-col">
                        <p class="text-gray-800 font-medium">${transaction.description} ${recurrenceText}</p>
                        <p class="text-sm text-gray-500">${transaction.timestamp ? transaction.timestamp.toDate().toLocaleDateString() : 'N/A'}</p>
                        ${debtDetails}
                        ${notesText}
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="text-lg font-semibold ${textColor}">
                            ${sign} ${formatCurrency(transaction.amount)}
                        </p>
                    </div>
                `;
                transactionsListEl.appendChild(transactionEl);
            });
        };
        const saveTransaction = async (e) => {
            e.preventDefault();
            
            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const type = typeSelect.value;
            const recurrence = recurrenceSelect.value;
            const notes = notesInput.value.trim();
            const interestRate = type === 'debt' ? parseFloat(interestRateInput.value) || null : null;
            const minPayment = type === 'debt' ? parseFloat(minPaymentInput.value) || null : null;

            const selectedDays = type === 'income' && (recurrence === 'weekly' || recurrence === 'biweekly') 
                ? Array.from(daysOfWeekCheckboxes).filter(cb => cb.checked).map(cb => cb.value) 
                : [];
            const monthlyDay = type === 'income' && recurrence === 'monthly' ? parseInt(monthlyDayInput.value) || null : null;
            
            let nextPayDate = nextPayDateInput.value ? nextPayDateInput.value : null;
            let timeZone = timezoneSelect.value;

            if (type === 'income' && recurrence !== 'none' && (!nextPayDate || !timeZone)) {
                showMessage("Please select a 'Next Pay Date' and 'Time Zone' for recurring income.", true, messageBoxEl);
                return;
            }

            if (description && !isNaN(amount) && amount > 0) {
                const transactionData = {
                    description,
                    amount,
                    type,
                    recurrence,
                    notes,
                    interestRate,
                    minPayment,
                    selectedDays,
                    monthlyDay,
                    nextPayDate,
                    timeZone
                };
                
                try {
                    if (editingTransactionId) {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, editingTransactionId);
                        await setDoc(docRef, transactionData, { merge: true });
                        showMessage("Transaction updated successfully!", false, messageBoxEl);
                    } else {
                        const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                        await addDoc(collectionRef, {
                            ...transactionData,
                            timestamp: serverTimestamp(),
                            ...(type === 'income' && recurrence !== 'none' && { lastAdded: serverTimestamp() })
                        });
                        showMessage("Transaction added successfully!", false, messageBoxEl);
                    }
                } catch (e) {
                    console.error("Error saving document: ", e);
                    showMessage("Error saving transaction.", true, messageBoxEl);
                }
                
                resetForm();
            } else {
                showMessage("Please enter a valid description and amount.", true, messageBoxEl);
            }
        };

        const editTransaction = (transaction) => {
            editingTransactionId = transaction.id;
            
            formTitle.textContent = 'Edit Transaction';
            saveTransactionBtn.textContent = 'Save Changes';
            deleteTransactionBtn.classList.remove('hidden');
            cancelEditBtn.classList.remove('hidden');

            descriptionInput.value = transaction.description;
            amountInput.value = transaction.amount;
            typeSelect.value = transaction.type;
            recurrenceSelect.value = transaction.recurrence;
            notesInput.value = transaction.notes || '';
            interestRateInput.value = transaction.interestRate || '';
            minPaymentInput.value = transaction.minPayment || '';
            
            if (transaction.type === 'income' && transaction.recurrence !== 'none') {
                if (transaction.selectedDays) {
                    daysOfWeekCheckboxes.forEach(cb => {
                        cb.checked = transaction.selectedDays.includes(cb.value);
                    });
                }
                monthlyDayInput.value = transaction.monthlyDay || '';
                nextPayDateInput.value = transaction.nextPayDate || '';
                timezoneSelect.value = transaction.timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone;
            }

            toggleDebtFields();
            toggleRecurrenceFields();
        };

        const deleteTransaction = async () => {
            if (!editingTransactionId) {
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, editingTransactionId);
                await deleteDoc(docRef);
                showMessage("Transaction deleted successfully!", false, messageBoxEl);
                resetForm();
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessage("Error removing transaction.", true, messageBoxEl);
            }
        };
        
        const getPaydayDateInTimeZone = (dateString, timeZone) => {
            const zonedDate = new Date(`${dateString}T12:00:00Z`);
            const options = { timeZone: timeZone, year: 'numeric', month: 'numeric', day: 'numeric' };
            const formatter = new Intl.DateTimeFormat('en-US', options);
            const parts = formatter.formatToParts(zonedDate);
        
            const year = parseInt(parts.find(p => p.type === 'year').value);
            const month = parseInt(parts.find(p => p.type === 'month').value);
            const day = parseInt(parts.find(p => p.type === 'day').value);
        
            return new Date(year, month - 1, day);
        };
        
        const processRecurringIncome = async (userTransactions) => {
            const today = new Date();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        
            const recurringIncomes = userTransactions.filter(t => t.type === 'income' && t.recurrence !== 'none');
        
            for (const income of recurringIncomes) {
                if (!income.nextPayDate || !income.timeZone) continue;
                
                const nextPayDate = getPaydayDateInTimeZone(income.nextPayDate, income.timeZone);
                const todayInTimeZone = getPaydayDateInTimeZone(today.toISOString().split('T')[0], income.timeZone);
        
                const lastAddedDate = income.lastAdded ? getPaydayDateInTimeZone(income.lastAdded.toDate().toISOString().split('T')[0], income.timeZone) : new Date(0);
                const isSameDayAsLastAddition = lastAddedDate.getDate() === todayInTimeZone.getDate() &&
                                               lastAddedDate.getMonth() === todayInTimeZone.getMonth() &&
                                               lastAddedDate.getFullYear() === todayInTimeZone.getFullYear();
                
                if (isSameDayAsLastAddition) continue;
        
                if (todayInTimeZone.getTime() >= nextPayDate.getTime()) {
                    let shouldAdd = false;
                    let newNextPayDate;
        
                    if (income.recurrence === 'weekly') {
                        if (income.selectedDays.includes(dayNames[todayInTimeZone.getDay()])) {
                            shouldAdd = true;
                            newNextPayDate = new Date(nextPayDate);
                            while (newNextPayDate.getTime() <= todayInTimeZone.getTime()) {
                                newNextPayDate.setDate(newNextPayDate.getDate() + 7);
                            }
                        }
                    } else if (income.recurrence === 'biweekly') {
                        if (income.selectedDays.includes(dayNames[todayInTimeZone.getDay()])) {
                            shouldAdd = true;
                            newNextPayDate = new Date(nextPayDate);
                            while (newNextPayDate.getTime() <= todayInTimeZone.getTime()) {
                                newNextPayDate.setDate(newNextPayDate.getDate() + 14);
                            }
                        }
                    } else if (income.recurrence === 'monthly' && income.monthlyDay === todayInTimeZone.getDate()) {
                        shouldAdd = true;
                        newNextPayDate = new Date(nextPayDate);
                        newNextPayDate.setMonth(newNextPayDate.getMonth() + 1);
                    }
                
                    if (shouldAdd) {
                        try {
                            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                            await addDoc(collectionRef, {
                                description: `${income.description} (Recurring)`,
                                amount: income.amount,
                                type: 'income',
                                recurrence: 'none',
                                notes: `Auto-added from recurring schedule.`,
                                timestamp: serverTimestamp()
                            });
        
                            const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, income.id);
                            await setDoc(docRef, { 
                                lastAdded: serverTimestamp(),
                                nextPayDate: newNextPayDate.toISOString().split('T')[0]
                            }, { merge: true });
        
                        } catch (e) {
                            console.error("Error adding recurring income: ", e);
                        }
                    }
                }
            }
        };
        
        const calculateSnowball = () => {
            snowballResultsEl.innerHTML = '';
            
            let debts = transactions.filter(t => t.type === 'debt').sort((a, b) => a.amount - b.amount);
            if (debts.length === 0) {
                snowballResultsEl.innerHTML = '<p class="text-center text-gray-500">No debts to track. Add some debt transactions first!</p>';
                return;
            }
        
            let extraPayment = parseFloat(extraPaymentInput.value);
            if (isNaN(extraPayment) || extraPayment < 0) {
                extraPayment = 0;
            }
        
            const startDate = new Date();
            let totalMonths = 0;
            let snowballPayment = extraPayment;
            let results = [];
        
            for (const debt of debts) {
                let currentBalance = debt.amount;
                let monthlyInterestRate = (debt.interestRate || 0) / 100 / 12;
                let monthsToPayoff = 0;
                let effectiveMonthlyPayment = (debt.minPayment || 0) + snowballPayment;
        
                while (currentBalance > 0) {
                    if (effectiveMonthlyPayment <= (currentBalance * monthlyInterestRate)) {
                        snowballResultsEl.innerHTML = `<p class="text-center text-red-500">Your payments are too low to pay off "${debt.description}" with its interest rate. Increase your extra payment.</p>`;
                        return;
                    }
        
                    const interest = currentBalance * monthlyInterestRate;
                    currentBalance += interest;
                    currentBalance -= effectiveMonthlyPayment;
                    monthsToPayoff++;
                }
        
                totalMonths += monthsToPayoff;
                snowballPayment += debt.minPayment || 0;
        
                const payoffDate = new Date();
                payoffDate.setMonth(startDate.getMonth() + totalMonths);
                
                results.push({
                    description: debt.description,
                    amount: debt.amount,
                    payoffDate: payoffDate,
                    months: monthsToPayoff,
                    cumulativeMonths: totalMonths
                });
            }
        
            results.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'p-4 rounded-xl bg-blue-50 shadow-sm';
                resultEl.innerHTML = `
                    <p class="text-gray-800 font-medium">${result.description}</p>
                    <p class="text-sm text-gray-600">Original Amount: ${formatCurrency(result.amount)}</p>
                    <p class="text-lg font-semibold text-blue-600">
                        Payoff Date: ${result.payoffDate.toLocaleDateString()}
                    </p>
                    <p class="text-sm text-gray-500">Paid off in ${result.months} months. Total payoff time: ${result.cumulativeMonths} months.</p>
                `;
                snowballResultsEl.appendChild(resultEl);
            });
        };
        
        const exportSnowballPlan = () => {
            const extraPayment = parseFloat(extraPaymentInput.value) || 0;
            
            let debts = transactions.filter(t => t.type === 'debt').sort((a, b) => a.amount - b.amount);
            
            if (debts.length === 0) {
                alert("Please add some debt transactions first.");
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,Debt,Original Amount,Interest Rate,Minimum Payment,Months to Payoff,Payoff Date\n";
            const startDate = new Date();
            let totalMonths = 0;
            let snowballPayment = extraPayment;
            
            for (const debt of debts) {
                let currentBalance = debt.amount;
                let monthlyInterestRate = (debt.interestRate || 0) / 100 / 12;
                let monthsToPayoff = 0;
                let effectiveMonthlyPayment = (debt.minPayment || 0) + snowballPayment;
        
                while (currentBalance > 0) {
                     if (effectiveMonthlyPayment <= (currentBalance * monthlyInterestRate)) {
                        alert(`Your payments are too low to pay off "${debt.description}" with its interest rate.`);
                        return;
                    }
                    const interest = currentBalance * monthlyInterestRate;
                    currentBalance += interest;
                    currentBalance -= effectiveMonthlyPayment;
                    monthsToPayoff++;
                }
        
                totalMonths += monthsToPayoff;
                snowballPayment += debt.minPayment || 0;
        
                const payoffDate = new Date();
                payoffDate.setMonth(startDate.getMonth() + totalMonths);
                const formattedPayoffDate = payoffDate.toLocaleDateString();
                
                csvContent += `${debt.description},${debt.amount},${debt.interestRate || 'N/A'},${debt.minPayment || 'N/A'},${monthsToPayoff},${formattedPayoffDate}\n`;
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "debt_snowball_plan.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // --- CALENDAR FUNCTIONS ---
        const renderPaydayCalendar = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const today = new Date();
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();

            currentMonthYearEl.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            calendarGridEl.innerHTML = '';

            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-sm font-semibold text-gray-600';
                dayHeader.textContent = day;
                calendarGridEl.appendChild(dayHeader);
            });

            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                calendarGridEl.appendChild(emptyDay);
            }

            const paydays = getPaydaysForMonth(year, month);
            let upcomingPaydaysHtml = '';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'p-2 rounded-xl text-center text-gray-800';
                
                const dayDate = new Date(year, month, day);
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;

                if (isToday) {
                    dayEl.classList.add('bg-blue-200', 'font-bold');
                }

                if (paydays[day] && paydays[day].length > 0) {
                    dayEl.classList.add('bg-green-500', 'text-white', 'font-bold', 'shadow-md');
                    paydays[day].forEach(income => {
                        upcomingPaydaysHtml += `<li>${dayDate.toLocaleDateString()} - ${income.description}: ${formatCurrency(income.amount)}</li>`;
                    });
                } else if (dayDate.getDay() === 0 || dayDate.getDay() === 6) {
                    dayEl.classList.add('bg-gray-200');
                } else {
                    dayEl.classList.add('bg-white');
                }

                dayEl.textContent = day;
                calendarGridEl.appendChild(dayEl);
            }
            upcomingPaydaysListEl.innerHTML = upcomingPaydaysHtml || '<li>No upcoming paydays this month.</li>';
        };

        const getPaydaysForMonth = (year, month) => {
            const paydays = {};
            
            transactions.filter(t => t.type === 'income' && t.recurrence !== 'none').forEach(income => {
                if (!income.nextPayDate) return;

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);

                let currentDate = getPaydayDateInTimeZone(income.nextPayDate, income.timeZone);

                while (currentDate.getTime() < firstDayOfMonth.getTime()) {
                    if (income.recurrence === 'weekly') {
                        currentDate.setDate(currentDate.getDate() + 7);
                    } else if (income.recurrence === 'biweekly') {
                        currentDate.setDate(currentDate.getDate() + 14);
                    } else if (income.recurrence === 'monthly') {
                        let newMonth = currentDate.getMonth() + 1;
                        let newYear = currentDate.getFullYear();
                        if (newMonth > 11) {
                            newMonth = 0;
                            newYear++;
                        }
                        const newDate = new Date(newYear, newMonth, Math.min(parseInt(income.monthlyDay), new Date(newYear, newMonth + 1, 0).getDate()));
                        currentDate = newDate;
                    }
                }
                
                while (currentDate.getFullYear() === year && currentDate.getMonth() === month) {
                    const day = currentDate.getDate();
                    if (!paydays[day]) {
                        paydays[day] = [];
                    }
                    paydays[day].push(income);

                    if (income.recurrence === 'weekly') {
                        currentDate.setDate(currentDate.getDate() + 7);
                    } else if (income.recurrence === 'biweekly') {
                        currentDate.setDate(currentDate.getDate() + 14);
                    } else if (income.recurrence === 'monthly') {
                        let newMonth = currentDate.getMonth() + 1;
                        let newYear = currentDate.getFullYear();
                        if (newMonth > 11) {
                            newMonth = 0;
                            newYear++;
                        }
                        const newDate = new Date(newYear, newMonth, Math.min(parseInt(income.monthlyDay), new Date(newYear, newMonth + 1, 0).getDate()));
                        currentDate = newDate;
                    }
                }
            });
            return paydays;
        };

        // --- TIME ZONE FUNCTIONS ---
        const populateTimezoneSelector = () => {
            const timezones = Intl.supportedValuesOf('timeZone');
            const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            timezones.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz;
                option.textContent = tz;
                timezoneSelect.appendChild(option);
            });
            
            timezoneSelect.value = userTimeZone;
        };

        // --- TAB NAVIGATION FUNCTIONALITY ---
        const showPage = (pageId) => {
            pageContainers.forEach(container => {
                container.classList.add('hidden');
            });
            tabButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            });

            document.getElementById(pageId).classList.remove('hidden');
            document.querySelector(`[data-page="${pageId.replace('-page', '')}"]`).classList.add('bg-indigo-600', 'text-white');
            document.querySelector(`[data-page="${pageId.replace('-page', '')}"]`).classList.remove('bg-gray-200', 'text-gray-800');

            if (pageId === 'calendar-page') {
                renderPaydayCalendar(currentCalendarDate);
            }
        };

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', handleLogin);
        showSignupBtn.addEventListener('click', showSignupForm);
        createAccountBtn.addEventListener('click', handleSignup);
        backToLoginBtn.addEventListener('click', showLoginForm);
        logoutBtn.addEventListener('click', () => signOut(auth));

        typeSelect.addEventListener('change', () => {
            toggleDebtFields();
            toggleRecurrenceFields();
        });
        recurrenceSelect.addEventListener('change', toggleRecurrenceFields);
        transactionForm.addEventListener('submit', saveTransaction);
        saveTransactionBtn.addEventListener('click', saveTransaction);
        deleteTransactionBtn.addEventListener('click', deleteTransaction);
        cancelEditBtn.addEventListener('click', resetForm);
        calculateSnowballBtn.addEventListener('click', calculateSnowball);
        downloadSnowballBtn.addEventListener('click', exportSnowballPlan);

        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderPaydayCalendar(currentCalendarDate);
        });
        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderPaydayCalendar(currentCalendarDate);
        });

        tabButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const pageId = e.target.dataset.page;
                showPage(`${pageId}-page`);
            });
        });

        populateTimezoneSelector();

        // --- FIREBASE AUTH STATE CHANGE HANDLER ---
        const handleAuthChange = async (user) => {
            if (user) {
                userId = user.uid;
                userIdEl.textContent = userId;
                authSection.classList.add('hidden');
                trackerSection.classList.remove('hidden');

                if (unsubscribeFromTransactions) {
                    unsubscribeFromTransactions();
                }

                const q = query(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                unsubscribeFromTransactions = onSnapshot(q, async (querySnapshot) => {
                    transactions = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    await processRecurringIncome(transactions);

                    updateSummary();
                    renderTransactions();
                    renderPaydayCalendar(currentCalendarDate);
                });

            } else {
                userId = '';
                authSection.classList.remove('hidden');
                trackerSection.classList.add('hidden');
                transactions = [];
                updateSummary();
                renderTransactions();
                renderPaydayCalendar(currentCalendarDate);
            }
        };

        onAuthStateChanged(auth, handleAuthChange);
    </script>
</body>
</html>
