<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <div id="auth-section" class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-md hidden">
        <div id="login-form">
            <h2 class="text-2xl font-bold text-center text-gray-800">Login</h2>
            <div id="login-message-box" class="mt-4 hidden p-3 rounded-lg text-center"></div>
            <div class="mt-4">
                <label for="loginEmail" class="sr-only">Email address</label>
                <input id="loginEmail" name="email" type="email" autocomplete="email" required class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-indigo-200" placeholder="Email address">
            </div>
            <div class="mt-2">
                <label for="loginPassword" class="sr-only">Password</label>
                <input id="loginPassword" name="password" type="password" autocomplete="current-password" required class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-indigo-200" placeholder="Password">
            </div>
            <button id="loginBtn" class="w-full mt-4 p-3 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-300">Sign in</button>
            <p class="mt-4 text-center text-sm text-gray-600">
                Don't have an account?
                <button id="showSignupBtn" class="text-indigo-600 hover:text-indigo-500 font-medium">Create an account</button>
            </p>
        </div>

        <div id="signup-form" class="hidden">
            <h2 class="text-2xl font-bold text-center text-gray-800">Create Account</h2>
            <div id="signup-message-box" class="mt-4 hidden p-3 rounded-lg text-center"></div>
            <div class="mt-4">
                <label for="signupEmail" class="sr-only">Email address</label>
                <input id="signupEmail" name="email" type="email" autocomplete="email" required class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-indigo-200" placeholder="Email address">
            </div>
            <div class="mt-2">
                <label for="signupPassword" class="sr-only">Password</label>
                <input id="signupPassword" name="password" type="password" autocomplete="new-password" required class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-indigo-200" placeholder="Password">
            </div>
            <div class="mt-2">
                <label for="confirmPassword" class="sr-only">Confirm Password</label>
                <input id="confirmPassword" name="confirmPassword" type="password" autocomplete="new-password" required class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-indigo-200" placeholder="Confirm Password">
            </div>
            <button id="createAccountBtn" class="w-full mt-4 p-3 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-300">Create Account</button>
            <p class="mt-4 text-center text-sm text-gray-600">
                Already have an account?
                <button id="backToLoginBtn" class="text-indigo-600 hover:text-indigo-500 font-medium">Sign in</button>
            </p>
        </div>
    </div>

    <div id="tracker-section" class="w-full max-w-5xl p-8 bg-white rounded-xl shadow-md hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Budget Tracker</h1>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-600">User ID: <span id="userId"></span></span>
                <button id="logoutBtn" class="p-2 font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-300">Logout</button>
            </div>
        </div>

        <div class="flex space-x-2 mb-6">
            <button id="transactions-tab" data-page="transactions" class="tab-btn p-3 rounded-t-lg bg-indigo-600 text-white font-medium transition-colors">Transactions</button>
            <button id="snowball-tab" data-page="snowball" class="tab-btn p-3 rounded-t-lg bg-gray-200 text-gray-800 font-medium transition-colors">Debt Snowball</button>
            <button id="calendar-tab" data-page="calendar" class="tab-btn p-3 rounded-t-lg bg-gray-200 text-gray-800 font-medium transition-colors">Payday Calendar</button>
        </div>

        <div id="transactions-page" class="page-content">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-gray-100 p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-medium text-gray-700">Total Balance</h3>
                    <p id="totalBalanceEl" class="text-3xl font-bold text-blue-600 mt-2"></p>
                </div>
                <div class="bg-gray-100 p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-medium text-gray-700">Total Income</h3>
                    <p id="totalIncomeEl" class="text-3xl font-bold text-green-600 mt-2"></p>
                </div>
                <div class="bg-gray-100 p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-medium text-gray-700">Total Expenses</h3>
                    <p id="totalExpensesEl" class="text-3xl font-bold text-red-600 mt-2"></p>
                </div>
            </div>

            <div class="mb-8 p-6 bg-gray-50 rounded-xl shadow-sm">
                <h3 id="form-title" class="text-xl font-bold text-gray-800">Add New Transaction</h3>
                <div id="message-box" class="mt-4 hidden p-3 rounded-lg text-center"></div>
                <form id="transactionForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div>
                        <label for="descriptionInput" class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" id="descriptionInput" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="amountInput" class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="number" id="amountInput" required class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="typeSelect" class="block text-sm font-medium text-gray-700">Type</label>
                        <select id="typeSelect" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                            <option value="debt">Debt</option>
                        </select>
                    </div>
                    <div>
                        <label for="recurrenceSelect" class="block text-sm font-medium text-gray-700">Recurrence</label>
                        <select id="recurrenceSelect" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                            <option value="none">None</option>
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Bi-weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div id="debt-fields" class="col-span-2 hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="interestRateInput" class="block text-sm font-medium text-gray-700">Interest Rate (%)</label>
                            <input type="number" id="interestRateInput" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="minPaymentInput" class="block text-sm font-medium text-gray-700">Minimum Payment</label>
                            <input type="number" id="minPaymentInput" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div id="recurring-fields" class="col-span-2 hidden space-y-4">
                        <div id="weekly-biweekly-fields" class="hidden">
                            <p class="block text-sm font-medium text-gray-700 mb-2">Select Payday(s):</p>
                            <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-2">
                                <div class="flex items-center">
                                    <input type="checkbox" id="sunday" value="sunday" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="sunday" class="ml-2 text-sm text-gray-700">Sun</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="monday" value="monday" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="monday" class="ml-2 text-sm text-gray-700">Mon</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="tuesday" value="tuesday" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="tuesday" class="ml-2 text-sm text-gray-700">Tue</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="wednesday" value="wednesday" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="wednesday" class="ml-2 text-sm text-gray-700">Wed</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="thursday" value="thursday" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="thursday" class="ml-2 text-sm text-gray-700">Thu</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="friday" value="friday" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="friday" class="ml-2 text-sm text-gray-700">Fri</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="saturday" value="saturday" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                                    <label for="saturday" class="ml-2 text-sm text-gray-700">Sat</label>
                                </div>
                            </div>
                        </div>
                        <div id="monthly-field" class="hidden">
                            <label for="monthlyDayInput" class="block text-sm font-medium text-gray-700">Payday of the Month (1-31)</label>
                            <input type="number" id="monthlyDayInput" min="1" max="31" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="nextPayDateInput" class="block text-sm font-medium text-gray-700">Next Pay Date</label>
                            <input type="date" id="nextPayDateInput" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="timezoneSelect" class="block text-sm font-medium text-gray-700">Time Zone</label>
                            <select id="timezoneSelect" class="mt-1 w-full p-2 border border-gray-300 rounded-md"></select>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <label for="notesInput" class="block text-sm font-medium text-gray-700">Notes (Optional)</label>
                        <textarea id="notesInput" rows="2" class="mt-1 w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div class="col-span-2 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <button type="submit" id="saveTransactionBtn" class="w-full sm:w-auto flex-1 p-3 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-300">Save Transaction</button>
                        <button type="button" id="deleteTransactionBtn" class="hidden w-full sm:w-auto flex-1 p-3 font-semibold text-white bg-red-600 rounded-md hover:bg-red-700 transition duration-300">Delete</button>
                        <button type="button" id="cancelEditBtn" class="hidden w-full sm:w-auto flex-1 p-3 font-semibold text-gray-800 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-300">Cancel Edit</button>
                    </div>
                </form>
            </div>

            <div id="transaction-history" class="bg-gray-50 p-6 rounded-xl shadow-sm">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Transaction History</h3>
                <div id="transactionsList" class="space-y-4">
                    <p class="text-center text-gray-500">No transactions found.</p>
                </div>
            </div>
        </div>

        <div id="snowball-page" class="page-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Debt Snowball Calculator</h2>
            <div class="p-6 bg-gray-50 rounded-xl shadow-sm mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Configure Your Plan</h3>
                <label for="extraPaymentInput" class="block text-sm font-medium text-gray-700">Extra Monthly Payment</label>
                <input type="number" id="extraPaymentInput" value="0" min="0" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
                <div class="mt-4 flex space-x-2">
                    <button id="calculateSnowballBtn" class="flex-1 p-3 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition duration-300">Calculate</button>
                    <button id="downloadSnowballBtn" class="flex-1 p-3 font-semibold text-gray-800 bg-gray-200 rounded-md hover:bg-gray-300 transition duration-300">Export Plan (CSV)</button>
                </div>
            </div>
            <div id="snowballResults" class="space-y-4">
                <p class="text-center text-gray-500">Press "Calculate" to see your plan.</p>
            </div>
        </div>

        <div id="calendar-page" class="page-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Payday Calendar</h2>
            <div class="bg-gray-50 p-6 rounded-xl shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonthBtn" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors">&lt;</button>
                    <h3 id="currentMonthYear" class="text-xl font-semibold text-gray-800"></h3>
                    <button id="nextMonthBtn" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 transition-colors">&gt;</button>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-center"></div>
            </div>
            <div class="mt-6 p-6 bg-gray-50 rounded-xl shadow-sm">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Upcoming Paydays</h3>
                <ul id="upcomingPaydaysList" class="list-disc list-inside space-y-1 text-gray-700"></ul>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDAMs4fq-aM3YJuBux2v4XRirGXGtW_bt4",
          authDomain: "financial-tracker-705f1.firebaseapp.com",
          projectId: "financial-tracker-705f1",
          storageBucket: "financial-tracker-705f1.firebasestorage.app",
          messagingSenderId: "284361332931",
          appId: "1:284361332931:web:b287647d246eb70a49aa76",
          measurementId: "G-VLF5B7LN6B"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM ELEMENTS ---
        const authSection = document.getElementById('auth-section');
        const trackerSection = document.getElementById('tracker-section');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const signupEmailInput = document.getElementById('signupEmail');
        const signupPasswordInput = document.getElementById('signupPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const loginBtn = document.getElementById('loginBtn');
        const showSignupBtn = document.getElementById('showSignupBtn');
        const createAccountBtn = document.getElementById('createAccountBtn');
        const backToLoginBtn = document.getElementById('backToLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginMessageBoxEl = document.getElementById('login-message-box');
        const signupMessageBoxEl = document.getElementById('signup-message-box');
        const userIdEl = document.getElementById('userId');

        const totalBalanceEl = document.getElementById('totalBalanceEl');
        const totalIncomeEl = document.getElementById('totalIncomeEl');
        const totalExpensesEl = document.getElementById('totalExpensesEl');
        const messageBoxEl = document.getElementById('message-box');
        const transactionForm = document.getElementById('transactionForm');
        const descriptionInput = document.getElementById('descriptionInput');
        const amountInput = document.getElementById('amountInput');
        const typeSelect = document.getElementById('typeSelect');
        const recurrenceSelect = document.getElementById('recurrenceSelect');
        const notesInput = document.getElementById('notesInput');
        const interestRateInput = document.getElementById('interestRateInput');
        const minPaymentInput = document.getElementById('minPaymentInput');
        const debtFields = document.getElementById('debt-fields');
        const recurringFields = document.getElementById('recurring-fields');
        const weeklyBiweeklyFields = document.getElementById('weekly-biweekly-fields');
        const daysOfWeekCheckboxes = document.querySelectorAll('#weekly-biweekly-fields input[type="checkbox"]');
        const monthlyField = document.getElementById('monthly-field');
        const monthlyDayInput = document.getElementById('monthlyDayInput');
        const nextPayDateInput = document.getElementById('nextPayDateInput');
        const timezoneSelect = document.getElementById('timezoneSelect');
        const transactionsListEl = document.getElementById('transactionsList');
        const saveTransactionBtn = document.getElementById('saveTransactionBtn');
        const deleteTransactionBtn = document.getElementById('deleteTransactionBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const calculateSnowballBtn = document.getElementById('calculateSnowballBtn');
        const downloadSnowballBtn = document.getElementById('downloadSnowballBtn');
        const extraPaymentInput = document.getElementById('extraPaymentInput');
        const snowballResultsEl = document.getElementById('snowballResults');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const calendarGridEl = document.getElementById('calendarGrid');
        const upcomingPaydaysListEl = document.getElementById('upcomingPaydaysList');
        const formTitle = document.getElementById('form-title');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const pageContainers = document.querySelectorAll('.page-content');

        // --- VARIABLES ---
        let userId = '';
        let transactions = [];
        let editingTransactionId = null;
        let unsubscribeFromTransactions;
        let currentCalendarDate = new Date();

        // --- HELPER FUNCTIONS ---
        const showMessage = (message, isError, element) => {
            element.textContent = message;
            element.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800');
            if (isError) {
                element.classList.add('bg-red-200', 'text-red-800');
            } else {
                element.classList.add('bg-green-200', 'text-green-800');
            }
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        };

        const toggleDebtFields = () => {
            if (typeSelect.value === 'debt') {
                debtFields.classList.remove('hidden');
            } else {
                debtFields.classList.add('hidden');
            }
        };

        const toggleRecurrenceFields = () => {
            if (typeSelect.value === 'income' && recurrenceSelect.value !== 'none') {
                recurringFields.classList.remove('hidden');
                if (recurrenceSelect.value === 'weekly' || recurrenceSelect.value === 'biweekly') {
                    weeklyBiweeklyFields.classList.remove('hidden');
                    monthlyField.classList.add('hidden');
                } else if (recurrenceSelect.value === 'monthly') {
                    monthlyField.classList.remove('hidden');
                    weeklyBiweeklyFields.classList.add('hidden');
                }
            } else {
                recurringFields.classList.add('hidden');
            }
        };

        const resetForm = () => {
            transactionForm.reset();
            editingTransactionId = null;
            formTitle.textContent = 'Add New Transaction';
            saveTransactionBtn.textContent = 'Save Transaction';
            deleteTransactionBtn.classList.add('hidden');
            cancelEditBtn.classList.add('hidden');
            toggleDebtFields();
            toggleRecurrenceFields();
        };

        const updateSummary = () => {
            const totalIncome = transactions.filter(t => t.type === 'income' && t.recurrence === 'none').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense' && t.recurrence === 'none').reduce((sum, t) => sum + t.amount, 0);
            const totalDebt = transactions.filter(t => t.type === 'debt' && t.recurrence === 'none').reduce((sum, t) => sum + t.amount, 0);

            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpensesEl.textContent = formatCurrency(totalExpenses);
            totalBalanceEl.textContent = formatCurrency(totalIncome - totalExpenses - totalDebt);
        };

        const renderTransactions = () => {
            transactionsListEl.innerHTML = '';
            if (transactions.length === 0) {
                transactionsListEl.innerHTML = '<p class="text-center text-gray-500">No transactions found.</p>';
                return;
            }

            const activeTransactions = transactions.filter(t => t.recurrence === 'none');
            const recurringTransactions = transactions.filter(t => t.recurrence !== 'none');

            const renderList = (list, title) => {
                if (list.length > 0) {
                    const sectionTitle = document.createElement('h4');
                    sectionTitle.className = 'text-lg font-bold text-gray-700 mb-2';
                    sectionTitle.textContent = title;
                    transactionsListEl.appendChild(sectionTitle);

                    list.sort((a, b) => b.timestamp - a.timestamp);

                    list.forEach(transaction => {
                        const transactionEl = document.createElement('div');
                        const amountClass = transaction.type === 'income' ? 'text-green-600' : (transaction.type === 'expense' ? 'text-red-600' : 'text-blue-600');
                        
                        transactionEl.className = 'flex justify-between items-center p-4 bg-white rounded-xl shadow-sm cursor-pointer hover:bg-gray-100 transition-colors';
                        transactionEl.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">${transaction.description}</p>
                                <p class="text-sm text-gray-500">${new Date(transaction.timestamp.toDate()).toLocaleDateString()}</p>
                                <p class="text-xs text-gray-400">Type: ${transaction.type}</p>
                            </div>
                            <div class="${amountClass} font-bold text-lg">
                                ${formatCurrency(transaction.amount)}
                            </div>
                        `;
                        transactionEl.addEventListener('click', () => editTransaction(transaction));
                        transactionsListEl.appendChild(transactionEl);
                    });
                }
            };
            
            renderList(activeTransactions, 'Past Transactions');
            renderList(recurringTransactions, 'Recurring Transactions');
        };

        // --- AUTH FUNCTIONS ---
        const handleLogin = async (e) => {
            e.preventDefault();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showMessage(`Login failed: ${error.message}`, true, loginMessageBoxEl);
            }
        };

        const handleSignup = async (e) => {
            e.preventDefault();
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (password !== confirmPassword) {
                showMessage("Passwords do not match.", true, signupMessageBoxEl);
                return;
            }
            if (password.length < 6) {
                showMessage("Password should be at least 6 characters.", true, signupMessageBoxEl);
                return;
            }

            try {
                await auth.createUserWithEmailAndPassword(email, password);
            } catch (error) {
                showMessage(`Signup failed: ${error.message}`, true, signupMessageBoxEl);
            }
        };

        const showLoginForm = () => {
            loginForm.classList.remove('hidden');
            signupForm.classList.add('hidden');
        };

        const showSignupForm = () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
        };

        // --- TRANSACTION FUNCTIONS ---
        const saveTransaction = async (e) => {
            e.preventDefault();
            
            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const type = typeSelect.value;
            const recurrence = recurrenceSelect.value;
            const notes = notesInput.value.trim();
            const interestRate = type === 'debt' ? parseFloat(interestRateInput.value) || null : null;
            const minPayment = type === 'debt' ? parseFloat(minPaymentInput.value) || null : null;

            const selectedDays = type === 'income' && (recurrence === 'weekly' || recurrence === 'biweekly') 
                ? Array.from(daysOfWeekCheckboxes).filter(cb => cb.checked).map(cb => cb.value) 
                : [];
            const monthlyDay = type === 'income' && recurrence === 'monthly' ? parseInt(monthlyDayInput.value) || null : null;
            
            let nextPayDate = nextPayDateInput.value ? nextPayDateInput.value : null;
            let timeZone = timezoneSelect.value;

            if (type === 'income' && recurrence !== 'none' && (!nextPayDate || !timeZone)) {
                showMessage("Please select a 'Next Pay Date' and 'Time Zone' for recurring income.", true, messageBoxEl);
                return;
            }
            if (description && !isNaN(amount) && amount > 0) {
                const transactionData = {
                    description,
                    amount,
                    type,
                    recurrence,
                    notes,
                    interestRate,
                    minPayment,
                    selectedDays,
                    monthlyDay,
                    nextPayDate,
                    timeZone
                };
                
                try {
                    if (editingTransactionId) {
                        const docRef = db.collection(`users/${userId}/transactions`).doc(editingTransactionId);
                        await docRef.set(transactionData, { merge: true });
                        showMessage("Transaction updated successfully!", false, messageBoxEl);
                    } else {
                        const collectionRef = db.collection(`users/${userId}/transactions`);
                        await collectionRef.add({
                            ...transactionData,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            ...(type === 'income' && recurrence !== 'none' && { lastAdded: firebase.firestore.FieldValue.serverTimestamp() })
                        });
                        showMessage("Transaction added successfully!", false, messageBoxEl);
                    }
                } catch (e) {
                    console.error("Error saving document: ", e);
                    showMessage("Error saving transaction.", true, messageBoxEl);
                }
                
                resetForm();
            } else {
                showMessage("Please enter a valid description and amount.", true, messageBoxEl);
            }
        };

        const editTransaction = (transaction) => {
            editingTransactionId = transaction.id;
            
            formTitle.textContent = 'Edit Transaction';
            saveTransactionBtn.textContent = 'Save Changes';
            deleteTransactionBtn.classList.remove('hidden');
            cancelEditBtn.classList.remove('hidden');

            descriptionInput.value = transaction.description;
            amountInput.value = transaction.amount;
            typeSelect.value = transaction.type;
            recurrenceSelect.value = transaction.recurrence;
            notesInput.value = transaction.notes || '';
            interestRateInput.value = transaction.interestRate || '';
            minPaymentInput.value = transaction.minPayment || '';
            
            if (transaction.type === 'income' && transaction.recurrence !== 'none') {
                if (transaction.selectedDays) {
                    daysOfWeekCheckboxes.forEach(cb => {
                        cb.checked = transaction.selectedDays.includes(cb.value);
                    });
                }
                monthlyDayInput.value = transaction.monthlyDay || '';
                nextPayDateInput.value = transaction.nextPayDate || '';
                timezoneSelect.value = transaction.timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone;
            }

            toggleDebtFields();
            toggleRecurrenceFields();
        };

        const deleteTransaction = async () => {
            if (!editingTransactionId) {
                return;
            }
            try {
                const docRef = db.collection(`users/${userId}/transactions`).doc(editingTransactionId);
                await docRef.delete();
                showMessage("Transaction deleted successfully!", false, messageBoxEl);
                resetForm();
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessage("Error removing transaction.", true, messageBoxEl);
            }
        };
        
        const getPaydayDateInTimeZone = (dateString, timeZone) => {
            const zonedDate = new Date(`${dateString}T12:00:00Z`);
            const options = { timeZone: timeZone, year: 'numeric', month: 'numeric', day: 'numeric' };
            const formatter = new Intl.DateTimeFormat('en-US', options);
            const parts = formatter.formatToParts(zonedDate);
        
            const year = parseInt(parts.find(p => p.type === 'year').value);
            const month = parseInt(parts.find(p => p.type === 'month').value);
            const day = parseInt(parts.find(p => p.type === 'day').value);
        
            return new Date(year, month - 1, day);
        };
        
        const processRecurringIncome = async (userTransactions) => {
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        
            const recurringIncomes = userTransactions.filter(t => t.type === 'income' && t.recurrence !== 'none');
        
            for (const income of recurringIncomes) {
                if (!income.nextPayDate || !income.timeZone) continue;
                
                const nextPayDate = getPaydayDateInTimeZone(income.nextPayDate, income.timeZone);
                const todayInTimeZone = getPaydayDateInTimeZone(new Date().toISOString().split('T')[0], income.timeZone);
        
                const lastAddedDate = income.lastAdded ? getPaydayDateInTimeZone(income.lastAdded.toDate().toISOString().split('T')[0], income.timeZone) : new Date(0);
                const isSameDayAsLastAddition = lastAddedDate.getTime() === todayInTimeZone.getTime();
                
                if (isSameDayAsLastAddition) continue;
        
                if (todayInTimeZone.getTime() >= nextPayDate.getTime()) {
                    let shouldAdd = false;
                    let newNextPayDate;
        
                    if (income.recurrence === 'weekly') {
                        if (income.selectedDays.includes(dayNames[todayInTimeZone.getDay()])) {
                            shouldAdd = true;
                            newNextPayDate = new Date(nextPayDate);
                            while (newNextPayDate.getTime() <= todayInTimeZone.getTime()) {
                                newNextPayDate.setDate(newNextPayDate.getDate() + 7);
                            }
                        }
                    } else if (income.recurrence === 'biweekly') {
                        if (income.selectedDays.includes(dayNames[todayInTimeZone.getDay()])) {
                            shouldAdd = true;
                            newNextPayDate = new Date(nextPayDate);
                            while (newNextPayDate.getTime() <= todayInTimeZone.getTime()) {
                                newNextPayDate.setDate(newNextPayDate.getDate() + 14);
                            }
                        }
                    } else if (income.recurrence === 'monthly' && income.monthlyDay === todayInTimeZone.getDate()) {
                        shouldAdd = true;
                        newNextPayDate = new Date(nextPayDate);
                        newNextPayDate.setMonth(newNextPayDate.getMonth() + 1);
                    }
                
                    if (shouldAdd) {
                        try {
                            const collectionRef = db.collection(`users/${userId}/transactions`);
                            await collectionRef.add({
                                description: `${income.description} (Recurring)`,
                                amount: income.amount,
                                type: 'income',
                                recurrence: 'none',
                                notes: `Auto-added from recurring schedule.`,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
        
                            const docRef = db.collection(`users/${userId}/transactions`).doc(income.id);
                            await docRef.set({ 
                                lastAdded: firebase.firestore.FieldValue.serverTimestamp(),
                                nextPayDate: newNextPayDate.toISOString().split('T')[0]
                            }, { merge: true });
        
                        } catch (e) {
                            console.error("Error adding recurring income: ", e);
                        }
                    }
                }
            }
        };
        
        const calculateSnowball = () => {
            snowballResultsEl.innerHTML = '';
            
            let debts = transactions.filter(t => t.type === 'debt').sort((a, b) => a.amount - b.amount);
            if (debts.length === 0) {
                snowballResultsEl.innerHTML = '<p class="text-center text-gray-500">No debts to track. Add some debt transactions first!</p>';
                return;
            }
        
            let extraPayment = parseFloat(extraPaymentInput.value);
            if (isNaN(extraPayment) || extraPayment < 0) {
                extraPayment = 0;
            }
        
            const startDate = new Date();
            let totalMonths = 0;
            let snowballPayment = extraPayment;
            let results = [];
        
            for (const debt of debts) {
                let currentBalance = debt.amount;
                let monthlyInterestRate = (debt.interestRate || 0) / 100 / 12;
                let monthsToPayoff = 0;
                let effectiveMonthlyPayment = (debt.minPayment || 0) + snowballPayment;
        
                if (effectiveMonthlyPayment <= (currentBalance * monthlyInterestRate) && effectiveMonthlyPayment > 0) {
                    snowballResultsEl.innerHTML = `<p class="text-center text-red-500">Your payments are too low to pay off "${debt.description}" with its interest rate. Increase your extra payment.</p>`;
                    return;
                }
                
                while (currentBalance > 0) {
                    const interest = currentBalance * monthlyInterestRate;
                    currentBalance += interest;
                    currentBalance -= effectiveMonthlyPayment;
                    monthsToPayoff++;
                }
        
                totalMonths += monthsToPayoff;
                snowballPayment += debt.minPayment || 0;
        
                const payoffDate = new Date();
                payoffDate.setMonth(startDate.getMonth() + totalMonths);
                
                results.push({
                    description: debt.description,
                    amount: debt.amount,
                    payoffDate: payoffDate,
                    months: monthsToPayoff,
                    cumulativeMonths: totalMonths
                });
            }
        
            results.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'p-4 rounded-xl bg-blue-50 shadow-sm';
                resultEl.innerHTML = `
                    <p class="text-gray-800 font-medium">${result.description}</p>
                    <p class="text-sm text-gray-600">Original Amount: ${formatCurrency(result.amount)}</p>
                    <p class="text-lg font-semibold text-blue-600">
                        Payoff Date: ${result.payoffDate.toLocaleDateString()}
                    </p>
                    <p class="text-sm text-gray-500">Paid off in ${result.months} months. Total payoff time: ${result.cumulativeMonths} months.</p>
                `;
                snowballResultsEl.appendChild(resultEl);
            });
        };
        
        const exportSnowballPlan = () => {
            const extraPayment = parseFloat(extraPaymentInput.value) || 0;
            
            let debts = transactions.filter(t => t.type === 'debt').sort((a, b) => a.amount - b.amount);
            
            if (debts.length === 0) {
                alert("Please add some debt transactions first.");
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,Debt,Original Amount,Interest Rate,Minimum Payment,Months to Payoff,Payoff Date\n";
            const startDate = new Date();
            let totalMonths = 0;
            let snowballPayment = extraPayment;
            
            for (const debt of debts) {
                let currentBalance = debt.amount;
                let monthlyInterestRate = (debt.interestRate || 0) / 100 / 12;
                let monthsToPayoff = 0;
                let effectiveMonthlyPayment = (debt.minPayment || 0) + snowballPayment;
        
                if (effectiveMonthlyPayment <= (currentBalance * monthlyInterestRate) && effectiveMonthlyPayment > 0) {
                     alert(`Your payments are too low to pay off "${debt.description}" with its interest rate.`);
                     return;
                }
                
                while (currentBalance > 0) {
                    const interest = currentBalance * monthlyInterestRate;
                    currentBalance += interest;
                    currentBalance -= effectiveMonthlyPayment;
                    monthsToPayoff++;
                }
        
                totalMonths += monthsToPayoff;
                snowballPayment += debt.minPayment || 0;
        
                const payoffDate = new Date();
                payoffDate.setMonth(startDate.getMonth() + totalMonths);
                const formattedPayoffDate = payoffDate.toLocaleDateString();
                
                csvContent += `${debt.description},${debt.amount},${debt.interestRate || 'N/A'},${debt.minPayment || 'N/A'},${monthsToPayoff},${formattedPayoffDate}\n`;
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "debt_snowball_plan.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // --- CALENDAR FUNCTIONS ---
        const renderPaydayCalendar = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const today = new Date();
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();

            currentMonthYearEl.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            calendarGridEl.innerHTML = '';

            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-sm font-semibold text-gray-600';
                dayHeader.textContent = day;
                calendarGridEl.appendChild(dayHeader);
            });

            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                calendarGridEl.appendChild(emptyDay);
            }

            const paydays = getPaydaysForMonth(year, month);
            let upcomingPaydaysHtml = '';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'p-2 rounded-xl text-center text-gray-800';
                
                const dayDate = new Date(year, month, day);
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;

                if (isToday) {
                    dayEl.classList.add('bg-blue-200', 'font-bold');
                }

                if (paydays[day] && paydays[day].length > 0) {
                    dayEl.classList.add('bg-green-500', 'text-white', 'font-bold', 'shadow-md');
                    paydays[day].forEach(income => {
                        upcomingPaydaysHtml += `<li>${dayDate.toLocaleDateString()} - ${income.description}: ${formatCurrency(income.amount)}</li>`;
                    });
                } else if (dayDate.getDay() === 0 || dayDate.getDay() === 6) {
                    dayEl.classList.add('bg-gray-200');
                } else {
                    dayEl.classList.add('bg-white');
                }
                
                dayEl.textContent = day;
                calendarGridEl.appendChild(dayEl);
            }
            upcomingPaydaysListEl.innerHTML = upcomingPaydaysHtml || '<li>No upcoming paydays this month.</li>';
        };

        const getPaydaysForMonth = (year, month) => {
            const paydays = {};
            
            transactions.filter(t => t.type === 'income' && t.recurrence !== 'none').forEach(income => {
                if (!income.nextPayDate) return;

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);

                let currentDate = getPaydayDateInTimeZone(income.nextPayDate, income.timeZone);

                while (currentDate.getFullYear() < year || (currentDate.getFullYear() === year && currentDate.getMonth() < month)) {
                    if (income.recurrence === 'weekly') {
                        currentDate.setDate(currentDate.getDate() + 7);
                    } else if (income.recurrence === 'biweekly') {
                        currentDate.setDate(currentDate.getDate() + 14);
                    } else if (income.recurrence === 'monthly') {
                        let newMonth = currentDate.getMonth() + 1;
                        let newYear = currentDate.getFullYear();
                        currentDate = new Date(newYear, newMonth, Math.min(parseInt(income.monthlyDay), new Date(newYear, newMonth + 1, 0).getDate()));
                    }
                }
                
                while (currentDate.getFullYear() === year && currentDate.getMonth() === month) {
                    const day = currentDate.getDate();
                    if (!paydays[day]) {
                        paydays[day] = [];
                    }
                    paydays[day].push(income);

                    if (income.recurrence === 'weekly') {
                        currentDate.setDate(currentDate.getDate() + 7);
                    } else if (income.recurrence === 'biweekly') {
                        currentDate.setDate(currentDate.getDate() + 14);
                    } else if (income.recurrence === 'monthly') {
                        let newMonth = currentDate.getMonth() + 1;
                        let newYear = currentDate.getFullYear();
                        currentDate = new Date(newYear, newMonth, Math.min(parseInt(income.monthlyDay), new Date(newYear, newMonth + 1, 0).getDate()));
                    }
                }
            });
            return paydays;
        };

        // --- TIME ZONE FUNCTIONS ---
        const populateTimezoneSelector = () => {
            const timezones = Intl.supportedValuesOf('timeZone');
            const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            timezones.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz;
                option.textContent = tz;
                timezoneSelect.appendChild(option);
            });
            
            timezoneSelect.value = userTimeZone;
        };

        // --- TAB NAVIGATION FUNCTIONALITY ---
        const showPage = (pageId) => {
            pageContainers.forEach(container => {
                container.classList.add('hidden');
            });
            tabButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            });

            document.getElementById(pageId).classList.remove('hidden');
            document.querySelector(`[data-page="${pageId.replace('-page', '')}"]`).classList.add('bg-indigo-600', 'text-white');
            document.querySelector(`[data-page="${pageId.replace('-page', '')}"]`).classList.remove('bg-gray-200', 'text-gray-800');

            if (pageId === 'calendar-page') {
                renderPaydayCalendar(currentCalendarDate);
            }
        };

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', handleLogin);
        showSignupBtn.addEventListener('click', showSignupForm);
        createAccountBtn.addEventListener('click', handleSignup);
        backToLoginBtn.addEventListener('click', showLoginForm);
        logoutBtn.addEventListener('click', () => auth.signOut());

        typeSelect.addEventListener('change', () => {
            toggleDebtFields();
            toggleRecurrenceFields();
        });
        recurrenceSelect.addEventListener('change', toggleRecurrenceFields);
        transactionForm.addEventListener('submit', saveTransaction);
        saveTransactionBtn.addEventListener('click', saveTransaction);
        deleteTransactionBtn.addEventListener('click', deleteTransaction);
        cancelEditBtn.addEventListener('click', resetForm);
        calculateSnowballBtn.addEventListener('click', calculateSnowball);
        downloadSnowballBtn.addEventListener('click', exportSnowballPlan);

        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderPaydayCalendar(currentCalendarDate);
        });
        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderPaydayCalendar(currentCalendarDate);
        });

        tabButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const pageId = e.target.dataset.page;
                showPage(`${pageId}-page`);
            });
        });

        populateTimezoneSelector();

        // --- FIREBASE AUTH STATE CHANGE HANDLER ---
        const handleAuthChange = async (user) => {
            if (user) {
                userId = user.uid;
                userIdEl.textContent = userId;
                authSection.classList.add('hidden');
                trackerSection.classList.remove('hidden');

                if (unsubscribeFromTransactions) {
                    unsubscribeFromTransactions();
                }
                
                const q = db.collection(`users/${userId}/transactions`);
                unsubscribeFromTransactions = q.onSnapshot(async (querySnapshot) => {
                    transactions = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    await processRecurringIncome(transactions);

                    updateSummary();
                    renderTransactions();
                    renderPaydayCalendar(currentCalendarDate);
                });

            } else {
                userId = '';
                authSection.classList.remove('hidden');
                trackerSection.classList.add('hidden');
                transactions = [];
                updateSummary();
                renderTransactions();
                renderPaydayCalendar(currentCalendarDate);
            }
        };

        auth.onAuthStateChanged(handleAuthChange);
    </script>
</body>
</html>
