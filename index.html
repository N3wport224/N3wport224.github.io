import { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, serverTimestamp } from 'firebase/firestore';

// Define Firebase config, app ID, and auth token from the global environment.
// This is essential for the app to connect to your Firebase project.
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// The main App component.
export default function App() {
  const [auth, setAuth] = useState(null);
  const [db, setDb] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [transactions, setTransactions] = useState([]);
  const [title, setTitle] = useState('');
  const [amount, setAmount] = useState('');
  const [type, setType] = useState('debt');
  const [recurrence, setRecurrence] = useState('none');
  const [message, setMessage] = useState('');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isFormVisible, setIsFormVisible] = useState(false);

  // useRef is used to prevent the auth state listener from being set up multiple times
  const authListenerRef = useRef(false);
  const transactionsListenerRef = useRef(null);

  // Effect for initializing Firebase and handling authentication.
  useEffect(() => {
    // Only run this effect once
    if (authListenerRef.current) return;
    authListenerRef.current = true;

    // Initialize Firebase services
    const firebaseApp = initializeApp(firebaseConfig);
    const authInstance = getAuth(firebaseApp);
    const dbInstance = getFirestore(firebaseApp);
    setAuth(authInstance);
    setDb(dbInstance);

    // Set up an authentication state listener.
    // This listener will handle both initial sign-in and subsequent logouts.
    const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
      if (user) {
        // User is signed in, set the user ID
        setUserId(user.uid);
        // We're ready to perform database operations
        setIsAuthReady(true);
      } else {
        // No user is signed in, sign in with the custom token or anonymously
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(authInstance, initialAuthToken);
          } else {
            await signInAnonymously(authInstance);
          }
        } catch (error) {
          console.error('Authentication failed:', error);
          setMessage(`Authentication failed: ${error.message}`);
          setIsModalOpen(true);
        }
      }
    });

    // Clean up the listener when the component unmounts
    return () => unsubscribe();
  }, []);

  // Effect for fetching and listening to real-time transaction data.
  useEffect(() => {
    // Wait until Firebase is initialized and authenticated
    if (!isAuthReady || !db || !userId) return;

    // Clean up the previous listener if it exists
    if (transactionsListenerRef.current) {
      transactionsListenerRef.current();
    }

    // Reference to the user's specific collection
    const transactionsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
    
    // Create a query to order transactions by timestamp
    const q = query(transactionsCollectionRef, where('userId', '==', userId));

    // Set up the real-time listener
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const transactionList = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setTransactions(transactionList);
    }, (error) => {
      console.error('Error fetching transactions:', error);
      setMessage(`Error fetching transactions: ${error.message}`);
      setIsModalOpen(true);
    });

    // Store the unsubscribe function to clean up later
    transactionsListenerRef.current = unsubscribe;

    // Clean up the listener when the component unmounts
    return () => {
      if (transactionsListenerRef.current) {
        transactionsListenerRef.current();
      }
    };
  }, [isAuthReady, db, userId]);

  // Handle adding a new transaction to Firestore
  const handleAddTransaction = async () => {
    if (!db || !userId) {
      setMessage('Error: User not authenticated.');
      setIsModalOpen(true);
      return;
    }

    const transaction = {
      title,
      amount: parseFloat(amount),
      type,
      recurrence,
      userId,
      timestamp: serverTimestamp(), // Use server timestamp for reliable ordering
    };

    try {
      // Add the new transaction document to the user's collection
      const transactionsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
      await setDoc(doc(transactionsCollectionRef), transaction);
      
      // Clear the form after successful submission
      setTitle('');
      setAmount('');
      setRecurrence('none');
      setIsFormVisible(false);
      setMessage('Transaction added successfully!');
      setTimeout(() => setMessage(''), 3000); // Clear message after 3 seconds
    } catch (error) {
      console.error('Error adding transaction:', error);
      setMessage(`Error adding transaction: ${error.message}`);
      setIsModalOpen(true);
    }
  };

  // Handle user logout
  const handleLogout = async () => {
    if (!auth) {
      setMessage('Authentication not initialized.');
      setIsModalOpen(true);
      return;
    }
    try {
      await signOut(auth);
      // The onAuthStateChanged listener will handle state updates and UI changes
      setMessage('Successfully logged out.');
      setTimeout(() => setMessage(''), 3000);
    } catch (error) {
      console.error('Error logging out:', error);
      setMessage(`Error logging out: ${error.message}`);
      setIsModalOpen(true);
    }
  };

  // UI components for the app
  const renderForm = () => (
    <div className="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg mx-auto">
      <h2 className="text-2xl font-bold mb-4 text-center text-gray-800">New Transaction</h2>
      <div className="mb-4">
        <label className="block text-gray-700 font-semibold mb-2" htmlFor="title">Title</label>
        <input
          id="title"
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          type="text"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          placeholder="e.g., Car Payment"
        />
      </div>
      <div className="mb-4">
        <label className="block text-gray-700 font-semibold mb-2" htmlFor="amount">Amount</label>
        <input
          id="amount"
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          type="number"
          value={amount}
          onChange={(e) => setAmount(e.target.value)}
          placeholder="e.g., 500"
        />
      </div>
      <div className="mb-4">
        <label className="block text-gray-700 font-semibold mb-2">Type</label>
        <div className="flex space-x-4">
          <label className="flex items-center">
            <input
              type="radio"
              value="debt"
              checked={type === 'debt'}
              onChange={() => setType('debt')}
              className="form-radio text-red-600"
            />
            <span className="ml-2 text-gray-700">Debt</span>
          </label>
          <label className="flex items-center">
            <input
              type="radio"
              value="credit"
              checked={type === 'credit'}
              onChange={() => setType('credit')}
              className="form-radio text-green-600"
            />
            <span className="ml-2 text-gray-700">Credit</span>
          </label>
        </div>
      </div>
      <div className="mb-4">
        <label className="block text-gray-700 font-semibold mb-2" htmlFor="recurrence">Recurrence</label>
        <select
          id="recurrence"
          className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
          value={recurrence}
          onChange={(e) => setRecurrence(e.target.value)}
        >
          <option value="none">None</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
        </select>
      </div>
      <button
        onClick={handleAddTransaction}
        className="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300"
      >
        Add Transaction
      </button>
      <button
        onClick={() => setIsFormVisible(false)}
        className="w-full mt-2 bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors duration-300"
      >
        Cancel
      </button>
    </div>
  );

  const renderTransactions = () => (
    <div className="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg mx-auto mt-8">
      <h2 className="text-2xl font-bold mb-4 text-center text-gray-800">My Transactions</h2>
      {transactions.length === 0 ? (
        <p className="text-center text-gray-500">No transactions yet. Add one to get started!</p>
      ) : (
        <ul className="divide-y divide-gray-200">
          {transactions.map((t) => (
            <li key={t.id} className="py-4 flex justify-between items-center">
              <div>
                <p className="text-lg font-semibold text-gray-800">{t.title}</p>
                <p className="text-sm text-gray-500 capitalize">{t.recurrence} {t.type}</p>
              </div>
              <p className={`text-xl font-bold ${t.type === 'debt' ? 'text-red-600' : 'text-green-600'}`}>
                ${t.amount.toFixed(2)}
              </p>
            </li>
          ))}
        </ul>
      )}
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-100 p-8 font-sans antialiased flex flex-col items-center">
      {/* Header and Logout button */}
      <div className="w-full max-w-lg mx-auto flex justify-between items-center mb-6">
        <h1 className="text-4xl font-extrabold text-gray-900 tracking-tight">Financify</h1>
        {isAuthReady && auth.currentUser && (
          <div className="flex items-center space-x-4">
            <span className="text-sm font-medium text-gray-600">
              {auth.currentUser.email}
            </span>
            <button
              onClick={handleLogout}
              className="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors duration-300"
            >
              Log Out
            </button>
          </div>
        )}
      </div>

      {/* Main UI and conditional rendering */}
      {!isFormVisible && (
        <div className="w-full max-w-lg mx-auto">
          <button
            onClick={() => setIsFormVisible(true)}
            className="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-300 transform hover:scale-105"
          >
            Add New Transaction
          </button>
        </div>
      )}
      
      {isFormVisible && renderForm()}
      
      {/* Show transactions only after authentication is ready */}
      {isAuthReady && auth.currentUser && renderTransactions()}

      {/* Message Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
            <p className="text-lg font-semibold text-gray-800">{message}</p>
            <button
              onClick={() => setIsModalOpen(false)}
              className="mt-4 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700"
            >
              Close
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

