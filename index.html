<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-10">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-gray-800">Financial Tracker</h1>
        
        <!-- User ID display for collaborative use -->
        <p class="text-center text-sm text-gray-400 mb-4">
            User ID: <span id="user-id" class="font-mono text-gray-600">Loading...</span>
        </p>

        <!-- Balance and Summary Section -->
        <div class="flex flex-col md:flex-row justify-between items-center bg-gray-100 rounded-2xl p-6 mb-6">
            <div class="text-center md:text-left mb-4 md:mb-0">
                <p class="text-lg text-gray-600 font-medium">Current Balance</p>
                <p id="total-balance" class="text-4xl md:text-5xl font-extrabold text-green-700 mt-1">$0.00</p>
            </div>
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-8">
                <div class="text-center">
                    <p class="text-base text-gray-600">Total Income</p>
                    <p id="total-income" class="text-xl font-semibold text-green-600 mt-1">$0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-base text-gray-600">Total Expenses</p>
                    <p id="total-expenses" class="text-xl font-semibold text-red-600 mt-1">$0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-base text-gray-600">Total Debt</p>
                    <p id="total-debt" class="text-xl font-semibold text-purple-600 mt-1">$0.00</p>
                </div>
            </div>
        </div>

        <!-- Add Transaction Form -->
        <div class="bg-gray-50 rounded-2xl p-6 md:p-8 mb-6">
            <h2 class="text-2xl font-semibold text-center mb-6 text-gray-700">Add New Transaction</h2>
            <form id="transaction-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                        <input type="text" id="description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2" placeholder="e.g., Groceries, Salary" required>
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="number" id="amount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2" placeholder="e.g., 50.00" required>
                    </div>
                </div>

                <div>
                    <label for="recurrence" class="block text-sm font-medium text-gray-700">Recurrence</label>
                    <select id="recurrence" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        <option value="none">None</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-center md:justify-end space-y-2 sm:space-y-0 sm:space-x-4 mt-6">
                    <button type="button" id="add-expense" class="bg-red-500 text-white font-medium py-2 px-6 rounded-xl shadow-md hover:bg-red-600 transition-colors">
                        Add Expense
                    </button>
                    <button type="button" id="add-income" class="bg-green-500 text-white font-medium py-2 px-6 rounded-xl shadow-md hover:bg-green-600 transition-colors">
                        Add Income
                    </button>
                    <button type="button" id="add-debt" class="bg-purple-500 text-white font-medium py-2 px-6 rounded-xl shadow-md hover:bg-purple-600 transition-colors">
                        Add Debt
                    </button>
                </div>
            </form>
        </div>

        <!-- Debt Snowball Tracker Section -->
        <div class="bg-gray-50 rounded-2xl p-6 md:p-8 mb-6">
            <h2 class="text-2xl font-semibold text-center mb-6 text-gray-700">Debt Snowball Tracker</h2>
            <div class="flex flex-col md:flex-row items-center justify-center md:justify-start space-y-4 md:space-y-0 md:space-x-4">
                <label for="extra-payment" class="text-sm font-medium text-gray-700">Monthly Extra Payment</label>
                <div class="relative w-full md:w-auto">
                    <input type="number" id="extra-payment" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 pl-8" value="0">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                </div>
                <button id="calculate-snowball" class="bg-blue-500 text-white font-medium py-2 px-6 rounded-xl shadow-md hover:bg-blue-600 transition-colors">
                    Calculate
                </button>
                <button id="download-snowball" class="bg-gray-500 text-white font-medium py-2 px-6 rounded-xl shadow-md hover:bg-gray-600 transition-colors">
                    Download Plan
                </button>
            </div>
            
            <div id="snowball-results" class="mt-6 space-y-4">
                <p class="text-center text-gray-500">Add some debts and an extra payment to calculate your plan.</p>
            </div>
        </div>

        <!-- Transaction History Section -->
        <div class="bg-gray-50 rounded-2xl p-6 md:p-8">
            <h2 class="text-2xl font-semibold text-center mb-6 text-gray-700">Transaction History</h2>
            <div id="transactions-list" class="space-y-4">
                <!-- Transaction items will be dynamically added here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = '';

        // Get DOM elements
        const transactionForm = document.getElementById('transaction-form');
        const descriptionInput = document.getElementById('description');
        const amountInput = document.getElementById('amount');
        const recurrenceSelect = document.getElementById('recurrence');
        const addIncomeBtn = document.getElementById('add-income');
        const addExpenseBtn = document.getElementById('add-expense');
        const addDebtBtn = document.getElementById('add-debt');
        const totalBalanceEl = document.getElementById('total-balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const totalDebtEl = document.getElementById('total-debt');
        const transactionsListEl = document.getElementById('transactions-list');
        const extraPaymentInput = document.getElementById('extra-payment');
        const calculateSnowballBtn = document.getElementById('calculate-snowball');
        const downloadSnowballBtn = document.getElementById('download-snowball');
        const snowballResultsEl = document.getElementById('snowball-results');
        const userIdEl = document.getElementById('user-id');

        // Main data array
        let transactions = [];
        let debts = [];

        // Function to format currency
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(amount);
        };

        // Function to update the summary totals
        const updateSummary = () => {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalDebt = transactions
                .filter(t => t.type === 'debt')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalBalance = totalIncome - totalExpenses - totalDebt;

            totalBalanceEl.textContent = formatCurrency(totalBalance);
            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpensesEl.textContent = formatCurrency(totalExpenses);
            totalDebtEl.textContent = formatCurrency(totalDebt);

            if (totalBalance < 0) {
                totalBalanceEl.classList.remove('text-green-700');
                totalBalanceEl.classList.add('text-red-700');
            } else {
                totalBalanceEl.classList.remove('text-red-700');
                totalBalanceEl.classList.add('text-green-700');
            }
        };

        // Function to render transactions in the history list
        const renderTransactions = () => {
            transactionsListEl.innerHTML = '';
            if (transactions.length === 0) {
                transactionsListEl.innerHTML = '<p class="text-center text-gray-500">No transactions added yet.</p>';
                return;
            }

            transactions.forEach((transaction) => {
                let bgColor, textColor, sign, iconColor;

                if (transaction.type === 'income') {
                    bgColor = 'bg-green-50';
                    textColor = 'text-green-600';
                    sign = '+';
                    iconColor = 'text-green-400';
                } else if (transaction.type === 'expense') {
                    bgColor = 'bg-red-50';
                    textColor = 'text-red-600';
                    sign = '-';
                    iconColor = 'text-red-400';
                } else if (transaction.type === 'debt') {
                    bgColor = 'bg-purple-50';
                    textColor = 'text-purple-600';
                    sign = '-';
                    iconColor = 'text-purple-400';
                }

                const transactionEl = document.createElement('div');
                transactionEl.className = `flex justify-between items-center p-4 rounded-xl shadow-sm transition-all duration-300 ${bgColor}`;

                let recurrenceText = '';
                if (transaction.recurrence && transaction.recurrence !== 'none') {
                    recurrenceText = `<span class="text-xs text-gray-500 ml-2">(${transaction.recurrence})</span>`;
                }

                transactionEl.innerHTML = `
                    <div class="flex flex-col">
                        <p class="text-gray-800 font-medium">${transaction.description} ${recurrenceText}</p>
                        <p class="text-sm text-gray-500">${new Date(transaction.date).toLocaleDateString()}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="text-lg font-semibold ${textColor}">
                            ${sign} ${formatCurrency(transaction.amount)}
                        </p>
                        <button class="remove-btn text-gray-400 hover:text-red-500 transition-colors" data-id="${transaction.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                transactionsListEl.appendChild(transactionEl);
            });

            // Add event listeners to remove buttons
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.dataset.id;
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'transactions', id);
                    try {
                        await deleteDoc(docRef);
                    } catch (e) {
                        console.error("Error removing document: ", e);
                    }
                });
            });
        };

        // Function to add a transaction to Firestore
        const addTransaction = async (type) => {
            if (!userId) {
                console.error("User not authenticated.");
                return;
            }

            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const recurrence = recurrenceSelect.value;
            const date = new Date().toISOString();

            if (description && !isNaN(amount) && amount > 0) {
                const newTransaction = {
                    description,
                    amount,
                    type,
                    recurrence,
                    date
                };
                
                try {
                    const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
                    await addDoc(collectionRef, newTransaction);
                    // UI will be updated by the onSnapshot listener
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
                
                // Clear the form
                transactionForm.reset();
            } else {
                // A custom modal would be better than an alert, but for now...
                window.alert('Please enter a valid description and amount.');
            }
        };

        // Debt Snowball Tracker Logic
        const calculateSnowball = () => {
            snowballResultsEl.innerHTML = '';
            
            // Get current debts from the main transactions array
            let debts = transactions.filter(t => t.type === 'debt');
            if (debts.length === 0) {
                snowballResultsEl.innerHTML = '<p class="text-center text-gray-500">No debts to track. Add some debt transactions first!</p>';
                return;
            }

            // Sort debts from smallest to largest balance
            debts.sort((a, b) => a.amount - b.amount);

            let extraPayment = parseFloat(extraPaymentInput.value);
            if (isNaN(extraPayment) || extraPayment < 0) {
                extraPayment = 0;
            }

            const startDate = new Date();
            let monthCounter = 0;
            let snowballPayment = extraPayment;
            let results = [];

            // Iterate through each debt
            for (let i = 0; i < debts.length; i++) {
                let currentDebt = { ...debts[i] };
                let monthsToPayoff = 0;
                let balance = currentDebt.amount;
                
                // Simulate payments month by month
                while (balance > 0) {
                    monthsToPayoff++;
                    balance -= snowballPayment;
                    if (balance <= 0) {
                        // This debt is paid off, add its regular payment to the snowball for the next debt
                        snowballPayment += 0; // Assuming no regular payments for simplicity
                    }
                }
                
                monthCounter += monthsToPayoff;
                const payoffDate = new Date(startDate.getFullYear(), startDate.getMonth() + monthCounter, startDate.getDate());
                
                results.push({
                    description: currentDebt.description,
                    amount: currentDebt.amount,
                    payoffDate: payoffDate,
                    months: monthCounter
                });
            }

            // Render the results
            results.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'p-4 rounded-xl bg-blue-50 shadow-sm';
                resultEl.innerHTML = `
                    <p class="text-gray-800 font-medium">${result.description}</p>
                    <p class="text-sm text-gray-600">Original Amount: ${formatCurrency(result.amount)}</p>
                    <p class="text-lg font-semibold text-blue-600">
                        Payoff Date: ${result.payoffDate.toLocaleDateString()}
                    </p>
                    <p class="text-sm text-gray-500">${result.months} months to payoff</p>
                `;
                snowballResultsEl.appendChild(resultEl);
            });
        };

        // Function to export the debt plan as a CSV file
        const exportSnowballPlan = () => {
            const extraPayment = parseFloat(extraPaymentInput.value) || 0;
            
            // Get debts from the main transactions array
            let debts = transactions.filter(t => t.type === 'debt');
            if (debts.length === 0) {
                window.alert('No debts to export.');
                return;
            }
            debts.sort((a, b) => a.amount - b.amount);

            // Headers for the CSV
            let csvContent = "data:text/csv;charset=utf-8,Debt Description,Original Amount,Payoff Date,Months to Payoff,Monthly Extra Payment\n";
            let snowballPayment = extraPayment;
            let monthCounter = 0;
            const startDate = new Date();

            debts.forEach(debt => {
                let balance = debt.amount;
                let monthsToPayoff = 0;
                
                while (balance > 0) {
                    monthsToPayoff++;
                    balance -= snowballPayment;
                    if (balance <= 0) {
                        snowballPayment += 0; // Assuming no regular payments
                    }
                }
                
                monthCounter += monthsToPayoff;
                const payoffDate = new Date(startDate.getFullYear(), startDate.getMonth() + monthCounter, startDate.getDate());

                // Format the row for the CSV
                const row = [
                    `"${debt.description.replace(/"/g, '""')}"`, // Handle commas and quotes
                    debt.amount,
                    `"${payoffDate.toLocaleDateString()}"`,
                    monthCounter,
                    extraPayment
                ].join(',');
                csvContent += row + '\n';
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "debt_snowball_plan.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Event listeners for the buttons
        addIncomeBtn.addEventListener('click', () => addTransaction('income'));
        addExpenseBtn.addEventListener('click', () => addTransaction('expense'));
        addDebtBtn.addEventListener('click', () => addTransaction('debt'));
        calculateSnowballBtn.addEventListener('click', calculateSnowball);
        downloadSnowballBtn.addEventListener('click', exportSnowballPlan);

        // Firebase Auth and Firestore setup
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdEl.textContent = userId;
                // Set up real-time listener for transactions
                const collectionRef = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
                const q = query(collectionRef);

                onSnapshot(q, (snapshot) => {
                    transactions = [];
                    snapshot.forEach((doc) => {
                        transactions.push({ id: doc.id, ...doc.data() });
                    });
                    renderTransactions();
                    updateSummary();
                    // Re-calculate the snowball whenever data changes
                    calculateSnowball();
                });
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication error:", error);
                    userIdEl.textContent = 'Error';
                }
            }
        });
    </script>
</body>
</html>

