<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
    <div id="auth-section" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-xl shadow-md w-full max-w-sm">
            <h1 id="auth-title" class="text-3xl font-bold text-center mb-6 text-indigo-600">Login</h1>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="login-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button type="button" id="login-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Login</button>
            </form>
            <p id="auth-message" class="text-center mt-4 text-sm hidden"></p>
            <div id="signup-fields" class="hidden">
                <input type="email" id="signup-email" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mt-4">
                <input type="password" id="signup-password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 mt-4">
                <button type="button" id="create-account-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition-colors mt-4">Create Account</button>
            </div>
            <p id="toggle-link" class="text-center mt-4 text-sm text-indigo-600 cursor-pointer">
                Don't have an account? <span id="show-signup-btn" class="font-semibold">Sign Up</span>
            </p>
            <button id="back-to-login-btn" class="w-full text-indigo-600 p-3 mt-2 rounded-lg font-semibold hidden">Back to Login</button>
        </div>
    </div>
    
    <div id="tracker-section" class="hidden">
        <header class="bg-white shadow-sm p-4 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-600">Finance Tracker</h1>
                <div class="flex items-center space-x-4">
                    <span id="user-id" class="text-gray-600 text-sm"></span>
                    <button id="logout-btn" class="text-red-500 hover:text-red-700 transition-colors">Logout</button>
                </div>
            </div>
        </header>

        <nav class="bg-white shadow-sm p-2 sticky top-16 z-40">
            <div class="container mx-auto flex justify-around">
                <button data-page="dashboard" class="tab-btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-xl transition-all duration-200">Dashboard</button>
                <button data-page="debt-snowball" class="tab-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl transition-all duration-200">Debt Snowball</button>
                <button data-page="calendar" class="tab-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl transition-all duration-200">Payday Calendar</button>
            </div>
        </nav>

        <main class="container mx-auto p-4 mt-4">
            <div id="dashboard-page" class="page-container">
                <div id="summary-section" class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <h2 class="text-xl font-bold mb-4">Summary</h2>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-lg text-gray-500">Balance</p>
                            <p id="total-balance" class="text-3xl font-bold text-green-700">$0.00</p>
                        </div>
                        <div>
                            <p class="text-lg text-gray-500">Income</p>
                            <p id="total-income" class="text-3xl font-bold text-green-700">$0.00</p>
                        </div>
                        <div>
                            <p class="text-lg text-gray-500">Expenses</p>
                            <p id="total-expenses" class="text-3xl font-bold text-red-700">$0.00</p>
                        </div>
                        <div>
                            <p class="text-lg text-gray-500">Debt</p>
                            <p id="total-debt" class="text-3xl font-bold text-purple-700">$0.00</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="transaction-form-section" class="bg-white p-6 rounded-xl shadow-md">
                        <h2 id="form-title" class="text-xl font-bold mb-4 text-indigo-600">Add New Transaction</h2>
                        <form id="transaction-form" class="space-y-4">
                            <div>
                                <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                                <select id="type-select" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="income">Income</option>
                                    <option value="expense">Expense</option>
                                    <option value="debt">Debt</option>
                                </select>
                            </div>
                            <div id="debt-fields" class="space-y-4 hidden">
                                <div>
                                    <label for="interest-rate" class="block text-sm font-medium text-gray-700">Interest Rate (%)</label>
                                    <input type="number" id="interest-rate-input" step="0.01" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="min-payment" class="block text-sm font-medium text-gray-700">Minimum Monthly Payment</label>
                                    <input type="number" id="min-payment-input" step="0.01" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <div id="recurring-income-fields" class="space-y-4 hidden">
                                <div>
                                    <label for="recurrence" class="block text-sm font-medium text-gray-700">Recurrence</label>
                                    <select id="recurrence-select" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="none">None</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="biweekly">Bi-weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                                <div id="weekly-days-container" class="hidden">
                                    <label class="block text-sm font-medium text-gray-700">Paydays (Select day(s) of the week)</label>
                                    <div class="grid grid-cols-3 md:grid-cols-7 gap-2 mt-2">
                                        <label class="flex items-center"><input type="checkbox" name="days" value="sunday" class="mr-2">Sun</label>
                                        <label class="flex items-center"><input type="checkbox" name="days" value="monday" class="mr-2">Mon</label>
                                        <label class="flex items-center"><input type="checkbox" name="days" value="tuesday" class="mr-2">Tue</label>
                                        <label class="flex items-center"><input type="checkbox" name="days" value="wednesday" class="mr-2">Wed</label>
                                        <label class="flex items-center"><input type="checkbox" name="days" value="thursday" class="mr-2">Thu</label>
                                        <label class="flex items-center"><input type="checkbox" name="days" value="friday" class="mr-2">Fri</label>
                                        <label class="flex items-center"><input type="checkbox" name="days" value="saturday" class="mr-2">Sat</label>
                                    </div>
                                </div>
                                <div id="monthly-day-container" class="hidden">
                                    <label for="monthly-day-input" class="block text-sm font-medium text-gray-700">Day of the Month</label>
                                    <input type="number" id="monthly-day-input" min="1" max="31" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="next-pay-date-input" class="block text-sm font-medium text-gray-700">Next Pay Date</label>
                                    <input type="date" id="next-pay-date-input" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="timezone-select" class="block text-sm font-medium text-gray-700">Time Zone</label>
                                    <select id="timezone-select" class="mt-1 w-full p-3 border border-gray-300 rounded-lg"></select>
                                </div>
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                                <input type="text" id="description-input" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700">Amount</label>
                                <input type="number" id="amount-input" step="0.01" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label for="notes" class="block text-sm font-medium text-gray-700">Notes (Optional)</label>
                                <textarea id="notes-input" rows="2" class="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                            </div>
                            <div id="message-box" class="p-3 text-center rounded-lg hidden"></div>
                            <button type="submit" id="save-transaction-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Add Transaction</button>
                            <button type="button" id="delete-transaction-btn" class="w-full bg-red-600 text-white p-3 mt-2 rounded-lg font-semibold hover:bg-red-700 transition-colors hidden">Delete Transaction</button>
                            <button type="button" id="cancel-edit-btn" class="w-full bg-gray-300 text-gray-800 p-3 mt-2 rounded-lg font-semibold hover:bg-gray-400 transition-colors hidden">Cancel Edit</button>
                        </form>
                    </div>

                    <div id="transactions-list-section" class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4">Transactions</h2>
                        <div id="transactions-list" class="space-y-4">
                            </div>
                    </div>
                </div>
            </div>

            <div id="debt-snowball-page" class="page-container hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-600">Debt Snowball Calculator</h2>
                    <p class="text-gray-600 mb-4">The debt snowball method is a debt-reduction strategy where you pay off debts in order of smallest to largest, gaining momentum as you pay off each debt. You can add an extra payment amount to speed up the process.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="extra-payment" class="block text-sm font-medium text-gray-700">Extra Monthly Payment</label>
                            <input type="number" id="extra-payment-input" step="0.01" value="0" class="mt-1 w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <button id="calculate-snowball-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Calculate Snowball Plan</button>
                        <button id="download-snowball-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">Export Plan to CSV</button>
                    </div>
                    <div id="snowball-results" class="mt-6 space-y-4">
                        </div>
                </div>
            </div>

            <div id="calendar-page" class="page-container hidden">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4 text-indigo-600">Payday Calendar</h2>
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">&lt;</button>
                        <h3 id="current-month-year" class="text-lg font-semibold"></h3>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">&gt;</button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center">
                        </div>
                    <div class="mt-6">
                        <h4 class="text-lg font-bold mb-2">Upcoming Paydays</h4>
                        <ul id="upcoming-paydays-list" class="list-disc list-inside space-y-1 text-gray-700">
                            </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // Your Firebase configuration object
        const firebaseConfig = {
          apiKey: "AIzaSyDAMs4fq-aM3YJuBux2v4XRirGXGtW_bt4",
          authDomain: "financial-tracker-705f1.firebaseapp.com",
          projectId: "financial-tracker-705f1",
          storageBucket: "financial-tracker-705f1.firebasestorage.app",
          messagingSenderId: "284361332931",
          appId: "1:284361332931:web:b287647d246eb70a49aa76",
          measurementId: "G-VLF5B7LN6B"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const { serverTimestamp } = firebase.firestore.FieldValue;
        const { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } = firebase.auth;
        const { collection, addDoc, doc, setDoc, deleteDoc, query, onSnapshot } = firebase.firestore;
        
        // App ID for the root collection
        const appId = firebaseConfig.projectId;
        let userId = null;
        let unsubscribeFromTransactions = null;
        let transactions = [];
        let editingTransactionId = null;

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const trackerSection = document.getElementById('tracker-section');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const showSignupBtn = document.getElementById('show-signup-btn');
        const createAccountBtn = document.getElementById('create-account-btn');
        const backToLoginBtn = document.getElementById('back-to-login-btn');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const authTitleEl = document.getElementById('auth-title');
        const authMessageEl = document.getElementById('auth-message');
        const signupFields = document.getElementById('signup-fields');
        const toggleLink = document.getElementById('toggle-link');
        const userIdEl = document.getElementById('user-id');
        const transactionForm = document.getElementById('transaction-form');
        const formTitle = document.getElementById('form-title');
        const descriptionInput = document.getElementById('description-input');
        const amountInput = document.getElementById('amount-input');
        const typeSelect = document.getElementById('type-select');
        const recurrenceSelect = document.getElementById('recurrence-select');
        const notesInput = document.getElementById('notes-input');
        const interestRateInput = document.getElementById('interest-rate-input');
        const minPaymentInput = document.getElementById('min-payment-input');
        const saveTransactionBtn = document.getElementById('save-transaction-btn');
        const deleteTransactionBtn = document.getElementById('delete-transaction-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const messageBoxEl = document.getElementById('message-box');
        const totalBalanceEl = document.getElementById('total-balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpensesEl = document.getElementById('total-expenses');
        const totalDebtEl = document.getElementById('total-debt');
        const transactionsListEl = document.getElementById('transactions-list');
        const debtFields = document.getElementById('debt-fields');
        const recurringIncomeFields = document.getElementById('recurring-income-fields');
        const weeklyDaysContainer = document.getElementById('weekly-days-container');
        const monthlyDayContainer = document.getElementById('monthly-day-container');
        const daysOfWeekCheckboxes = document.querySelectorAll('#weekly-days-container input[type="checkbox"]');
        const monthlyDayInput = document.getElementById('monthly-day-input');
        const nextPayDateInput = document.getElementById('next-pay-date-input');
        const timezoneSelect = document.getElementById('timezone-select');
        const calculateSnowballBtn = document.getElementById('calculate-snowball-btn');
        const extraPaymentInput = document.getElementById('extra-payment-input');
        const snowballResultsEl = document.getElementById('snowball-results');
        const downloadSnowballBtn = document.getElementById('download-snowball-btn');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const calendarGridEl = document.getElementById('calendar-grid');
        const upcomingPaydaysListEl = document.getElementById('upcoming-paydays-list');
        const pageContainers = document.querySelectorAll('.page-container');
        const tabButtons = document.querySelectorAll('.tab-btn');
        let currentCalendarDate = new Date();

        // --- AUTH FUNCTIONS ---
        const handleLogin = async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                showMessage("Please enter both email and password.", true, authMessageEl);
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                let errorMessage = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Invalid email or password.";
                }
                showMessage(errorMessage, true, authMessageEl);
            }
        };

        const handleSignup = async () => {
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            if (password.length < 6) {
                showMessage("Password should be at least 6 characters.", true, authMessageEl);
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Account created successfully! You are now logged in.", false, authMessageEl);
            } catch (error) {
                let errorMessage = "Failed to create account.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already in use.";
                }
                showMessage(errorMessage, true, authMessageEl);
            }
        };

        const showSignupForm = () => {
            authTitleEl.textContent = 'Create Account';
            toggleLink.classList.add('hidden');
            signupFields.classList.remove('hidden');
            backToLoginBtn.classList.remove('hidden');
            loginBtn.classList.add('hidden');
            authForm.reset();
            authMessageEl.classList.add('hidden');
        };

        const showLoginForm = () => {
            authTitleEl.textContent = 'Login';
            toggleLink.classList.remove('hidden');
            signupFields.classList.add('hidden');
            backToLoginBtn.classList.add('hidden');
            loginBtn.classList.remove('hidden');
            authForm.reset();
            authMessageEl.classList.add('hidden');
        };

        // --- TRANSACTION AND UI FUNCTIONS ---
        const toggleDebtFields = () => {
            if (typeSelect.value === 'debt') {
                debtFields.classList.remove('hidden');
            } else {
                debtFields.classList.add('hidden');
            }
        };

        const toggleRecurrenceFields = () => {
            const type = typeSelect.value;
            const recurrence = recurrenceSelect.value;
            
            recurringIncomeFields.classList.add('hidden');
            weeklyDaysContainer.classList.add('hidden');
            monthlyDayContainer.classList.add('hidden');
            nextPayDateInput.closest('div').classList.add('hidden');
            timezoneSelect.closest('div').classList.add('hidden');

            if (type === 'income' && recurrence !== 'none') {
                recurringIncomeFields.classList.remove('hidden');
                nextPayDateInput.closest('div').classList.remove('hidden');
                timezoneSelect.closest('div').classList.remove('hidden');

                if (recurrence === 'weekly' || recurrence === 'biweekly') {
                    weeklyDaysContainer.classList.remove('hidden');
                } else if (recurrence === 'monthly') {
                    monthlyDayContainer.classList.remove('hidden');
                }
            }
        };

        const resetForm = () => {
            transactionForm.reset();
            formTitle.textContent = 'Add New Transaction';
            saveTransactionBtn.textContent = 'Add Transaction';
            deleteTransactionBtn.classList.add('hidden');
            cancelEditBtn.classList.add('hidden');
            editingTransactionId = null;
            interestRateInput.value = '';
            minPaymentInput.value = '';
            toggleDebtFields();
            toggleRecurrenceFields();
        };

        const showMessage = (msg, isError = false, targetEl) => {
            targetEl.textContent = msg;
            targetEl.classList.remove('hidden');
            targetEl.classList.toggle('text-red-500', isError);
            targetEl.classList.toggle('text-green-500', !isError);
            setTimeout(() => {
                targetEl.classList.add('hidden');
            }, 5000);
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            }).format(amount);
        };

        const updateSummary = () => {
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalDebt = transactions
                .filter(t => t.type === 'debt')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalBalance = totalIncome - totalExpenses - totalDebt;

            totalBalanceEl.textContent = formatCurrency(totalBalance);
            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpensesEl.textContent = formatCurrency(totalExpenses);
            totalDebtEl.textContent = formatCurrency(totalDebt);

            if (totalBalance < 0) {
                totalBalanceEl.classList.remove('text-green-700');
                totalBalanceEl.classList.add('text-red-700');
            } else {
                totalBalanceEl.classList.remove('text-red-700');
                totalBalanceEl.classList.add('text-green-700');
            }
        };

        const renderTransactions = () => {
            transactionsListEl.innerHTML = '';
            if (transactions.length === 0) {
                transactionsListEl.innerHTML = '<p class="text-center text-gray-500">No transactions added yet.</p>';
                return;
            }

            const sortedTransactions = transactions.sort((a, b) => {
                const dateA = a.timestamp ? a.timestamp.toDate() : new Date();
                const dateB = b.timestamp ? b.timestamp.toDate() : new Date();
                return dateB - dateA;
            });

            sortedTransactions.forEach((transaction) => {
                let bgColor, textColor, sign;

                if (transaction.type === 'income') {
                    bgColor = 'bg-green-50';
                    textColor = 'text-green-600';
                    sign = '+';
                } else if (transaction.type === 'expense') {
                    bgColor = 'bg-red-50';
                    textColor = 'text-red-600';
                    sign = '-';
                } else if (transaction.type === 'debt') {
                    bgColor = 'bg-purple-50';
                    textColor = 'text-purple-600';
                    sign = '-';
                }

                const transactionEl = document.createElement('div');
                transactionEl.className = `flex justify-between items-center p-4 rounded-xl shadow-sm transition-all duration-300 ${bgColor} hover:bg-gray-100 cursor-pointer`;
                transactionEl.dataset.id = transaction.id;
                transactionEl.addEventListener('click', () => editTransaction(transaction));

                let recurrenceText = '';
                if (transaction.recurrence && transaction.recurrence !== 'none') {
                    recurrenceText = `<span class="text-xs text-gray-500 ml-2">(${transaction.recurrence})</span>`;
                }

                let notesText = '';
                if (transaction.notes) {
                    notesText = `<p class="text-xs text-gray-400 mt-1">Notes: ${transaction.notes}</p>`;
                }
                
                let debtDetails = '';
                if (transaction.type === 'debt') {
                    debtDetails = `<div class="text-xs text-gray-400 mt-1">
                        ${transaction.interestRate ? `Interest: ${transaction.interestRate}%` : ''}
                        ${transaction.interestRate && transaction.minPayment ? ' | ' : ''}
                        ${transaction.minPayment ? `Min. Pmt: $${transaction.minPayment.toFixed(2)}` : ''}
                    </div>`;
                }
                
                transactionEl.innerHTML = `
                    <div class="flex flex-col">
                        <p class="text-gray-800 font-medium">${transaction.description} ${recurrenceText}</p>
                        <p class="text-sm text-gray-500">${transaction.timestamp ? transaction.timestamp.toDate().toLocaleDateString() : 'N/A'}</p>
                        ${debtDetails}
                        ${notesText}
                    </div>
                    <div class="flex items-center space-x-2">
                        <p class="text-lg font-semibold ${textColor}">
                            ${sign} ${formatCurrency(transaction.amount)}
                        </p>
                    </div>
                `;
                transactionsListEl.appendChild(transactionEl);
            });
        };
        const saveTransaction = async (e) => {
            e.preventDefault();
            
            const description = descriptionInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const type = typeSelect.value;
            const recurrence = recurrenceSelect.value;
            const notes = notesInput.value.trim();
            const interestRate = type === 'debt' ? parseFloat(interestRateInput.value) || null : null;
            const minPayment = type === 'debt' ? parseFloat(minPaymentInput.value) || null : null;

            const selectedDays = type === 'income' && (recurrence === 'weekly' || recurrence === 'biweekly') 
                ? Array.from(daysOfWeekCheckboxes).filter(cb => cb.checked).map(cb => cb.value) 
                : [];
            const monthlyDay = type === 'income' && recurrence === 'monthly' ? parseInt(monthlyDayInput.value) || null : null;
            
            let nextPayDate = nextPayDateInput.value ? nextPayDateInput.value : null;
            let timeZone = timezoneSelect.value;

            if (type === 'income' && recurrence !== 'none' && (!nextPayDate || !timeZone)) {
                showMessage("Please select a 'Next Pay Date' and 'Time Zone' for recurring income.", true, messageBoxEl);
                return;
            }
            if (description && !isNaN(amount) && amount > 0) {
                const transactionData = {
                    description,
                    amount,
                    type,
                    recurrence,
                    notes,
                    interestRate,
                    minPayment,
                    selectedDays,
                    monthlyDay,
                    nextPayDate,
                    timeZone
                };
                
                try {
                    if (editingTransactionId) {
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, editingTransactionId);
                        await setDoc(docRef, transactionData, { merge: true });
                        showMessage("Transaction updated successfully!", false, messageBoxEl);
                    } else {
                        const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                        await addDoc(collectionRef, {
                            ...transactionData,
                            timestamp: serverTimestamp(),
                            ...(type === 'income' && recurrence !== 'none' && { lastAdded: serverTimestamp() })
                        });
                        showMessage("Transaction added successfully!", false, messageBoxEl);
                    }
                } catch (e) {
                    console.error("Error saving document: ", e);
                    showMessage("Error saving transaction.", true, messageBoxEl);
                }
                
                resetForm();
            } else {
                showMessage("Please enter a valid description and amount.", true, messageBoxEl);
            }
        };

        const editTransaction = (transaction) => {
            editingTransactionId = transaction.id;
            
            formTitle.textContent = 'Edit Transaction';
            saveTransactionBtn.textContent = 'Save Changes';
            deleteTransactionBtn.classList.remove('hidden');
            cancelEditBtn.classList.remove('hidden');

            descriptionInput.value = transaction.description;
            amountInput.value = transaction.amount;
            typeSelect.value = transaction.type;
            recurrenceSelect.value = transaction.recurrence;
            notesInput.value = transaction.notes || '';
            interestRateInput.value = transaction.interestRate || '';
            minPaymentInput.value = transaction.minPayment || '';
            
            if (transaction.type === 'income' && transaction.recurrence !== 'none') {
                if (transaction.selectedDays) {
                    daysOfWeekCheckboxes.forEach(cb => {
                        cb.checked = transaction.selectedDays.includes(cb.value);
                    });
                }
                monthlyDayInput.value = transaction.monthlyDay || '';
                nextPayDateInput.value = transaction.nextPayDate || '';
                timezoneSelect.value = transaction.timeZone || Intl.DateTimeFormat().resolvedOptions().timeZone;
            }

            toggleDebtFields();
            toggleRecurrenceFields();
        };

        const deleteTransaction = async () => {
            if (!editingTransactionId) {
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, editingTransactionId);
                await deleteDoc(docRef);
                showMessage("Transaction deleted successfully!", false, messageBoxEl);
                resetForm();
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessage("Error removing transaction.", true, messageBoxEl);
            }
        };
        
        const getPaydayDateInTimeZone = (dateString, timeZone) => {
            const zonedDate = new Date(`${dateString}T12:00:00Z`);
            const options = { timeZone: timeZone, year: 'numeric', month: 'numeric', day: 'numeric' };
            const formatter = new Intl.DateTimeFormat('en-US', options);
            const parts = formatter.formatToParts(zonedDate);
        
            const year = parseInt(parts.find(p => p.type === 'year').value);
            const month = parseInt(parts.find(p => p.type === 'month').value);
            const day = parseInt(parts.find(p => p.type === 'day').value);
        
            return new Date(year, month - 1, day);
        };
        
        const processRecurringIncome = async (userTransactions) => {
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        
            const recurringIncomes = userTransactions.filter(t => t.type === 'income' && t.recurrence !== 'none');
        
            for (const income of recurringIncomes) {
                if (!income.nextPayDate || !income.timeZone) continue;
                
                const nextPayDate = getPaydayDateInTimeZone(income.nextPayDate, income.timeZone);
                const todayInTimeZone = getPaydayDateInTimeZone(new Date().toISOString().split('T')[0], income.timeZone);
        
                const lastAddedDate = income.lastAdded ? getPaydayDateInTimeZone(income.lastAdded.toDate().toISOString().split('T')[0], income.timeZone) : new Date(0);
                const isSameDayAsLastAddition = lastAddedDate.getTime() === todayInTimeZone.getTime();
                
                if (isSameDayAsLastAddition) continue;
        
                if (todayInTimeZone.getTime() >= nextPayDate.getTime()) {
                    let shouldAdd = false;
                    let newNextPayDate;
        
                    if (income.recurrence === 'weekly') {
                        if (income.selectedDays.includes(dayNames[todayInTimeZone.getDay()])) {
                            shouldAdd = true;
                            newNextPayDate = new Date(nextPayDate);
                            while (newNextPayDate.getTime() <= todayInTimeZone.getTime()) {
                                newNextPayDate.setDate(newNextPayDate.getDate() + 7);
                            }
                        }
                    } else if (income.recurrence === 'biweekly') {
                        if (income.selectedDays.includes(dayNames[todayInTimeZone.getDay()])) {
                            shouldAdd = true;
                            newNextPayDate = new Date(nextPayDate);
                            while (newNextPayDate.getTime() <= todayInTimeZone.getTime()) {
                                newNextPayDate.setDate(newNextPayDate.getDate() + 14);
                            }
                        }
                    } else if (income.recurrence === 'monthly' && income.monthlyDay === todayInTimeZone.getDate()) {
                        shouldAdd = true;
                        newNextPayDate = new Date(nextPayDate);
                        newNextPayDate.setMonth(newNextPayDate.getMonth() + 1);
                    }
                
                    if (shouldAdd) {
                        try {
                            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                            await addDoc(collectionRef, {
                                description: `${income.description} (Recurring)`,
                                amount: income.amount,
                                type: 'income',
                                recurrence: 'none',
                                notes: `Auto-added from recurring schedule.`,
                                timestamp: serverTimestamp()
                            });
        
                            const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, income.id);
                            await setDoc(docRef, { 
                                lastAdded: serverTimestamp(),
                                nextPayDate: newNextPayDate.toISOString().split('T')[0]
                            }, { merge: true });
        
                        } catch (e) {
                            console.error("Error adding recurring income: ", e);
                        }
                    }
                }
            }
        };
        
        const calculateSnowball = () => {
            snowballResultsEl.innerHTML = '';
            
            let debts = transactions.filter(t => t.type === 'debt').sort((a, b) => a.amount - b.amount);
            if (debts.length === 0) {
                snowballResultsEl.innerHTML = '<p class="text-center text-gray-500">No debts to track. Add some debt transactions first!</p>';
                return;
            }
        
            let extraPayment = parseFloat(extraPaymentInput.value);
            if (isNaN(extraPayment) || extraPayment < 0) {
                extraPayment = 0;
            }
        
            const startDate = new Date();
            let totalMonths = 0;
            let snowballPayment = extraPayment;
            let results = [];
        
            for (const debt of debts) {
                let currentBalance = debt.amount;
                let monthlyInterestRate = (debt.interestRate || 0) / 100 / 12;
                let monthsToPayoff = 0;
                let effectiveMonthlyPayment = (debt.minPayment || 0) + snowballPayment;
        
                if (effectiveMonthlyPayment <= (currentBalance * monthlyInterestRate) && effectiveMonthlyPayment > 0) {
                    snowballResultsEl.innerHTML = `<p class="text-center text-red-500">Your payments are too low to pay off "${debt.description}" with its interest rate. Increase your extra payment.</p>`;
                    return;
                }
                
                while (currentBalance > 0) {
                    const interest = currentBalance * monthlyInterestRate;
                    currentBalance += interest;
                    currentBalance -= effectiveMonthlyPayment;
                    monthsToPayoff++;
                }
        
                totalMonths += monthsToPayoff;
                snowballPayment += debt.minPayment || 0;
        
                const payoffDate = new Date();
                payoffDate.setMonth(startDate.getMonth() + totalMonths);
                
                results.push({
                    description: debt.description,
                    amount: debt.amount,
                    payoffDate: payoffDate,
                    months: monthsToPayoff,
                    cumulativeMonths: totalMonths
                });
            }
        
            results.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'p-4 rounded-xl bg-blue-50 shadow-sm';
                resultEl.innerHTML = `
                    <p class="text-gray-800 font-medium">${result.description}</p>
                    <p class="text-sm text-gray-600">Original Amount: ${formatCurrency(result.amount)}</p>
                    <p class="text-lg font-semibold text-blue-600">
                        Payoff Date: ${result.payoffDate.toLocaleDateString()}
                    </p>
                    <p class="text-sm text-gray-500">Paid off in ${result.months} months. Total payoff time: ${result.cumulativeMonths} months.</p>
                `;
                snowballResultsEl.appendChild(resultEl);
            });
        };
        
        const exportSnowballPlan = () => {
            const extraPayment = parseFloat(extraPaymentInput.value) || 0;
            
            let debts = transactions.filter(t => t.type === 'debt').sort((a, b) => a.amount - b.amount);
            
            if (debts.length === 0) {
                alert("Please add some debt transactions first.");
                return;
            }
            
            let csvContent = "data:text/csv;charset=utf-8,Debt,Original Amount,Interest Rate,Minimum Payment,Months to Payoff,Payoff Date\n";
            const startDate = new Date();
            let totalMonths = 0;
            let snowballPayment = extraPayment;
            
            for (const debt of debts) {
                let currentBalance = debt.amount;
                let monthlyInterestRate = (debt.interestRate || 0) / 100 / 12;
                let monthsToPayoff = 0;
                let effectiveMonthlyPayment = (debt.minPayment || 0) + snowballPayment;
        
                if (effectiveMonthlyPayment <= (currentBalance * monthlyInterestRate) && effectiveMonthlyPayment > 0) {
                     alert(`Your payments are too low to pay off "${debt.description}" with its interest rate.`);
                     return;
                }
                
                while (currentBalance > 0) {
                    const interest = currentBalance * monthlyInterestRate;
                    currentBalance += interest;
                    currentBalance -= effectiveMonthlyPayment;
                    monthsToPayoff++;
                }
        
                totalMonths += monthsToPayoff;
                snowballPayment += debt.minPayment || 0;
        
                const payoffDate = new Date();
                payoffDate.setMonth(startDate.getMonth() + totalMonths);
                const formattedPayoffDate = payoffDate.toLocaleDateString();
                
                csvContent += `${debt.description},${debt.amount},${debt.interestRate || 'N/A'},${debt.minPayment || 'N/A'},${monthsToPayoff},${formattedPayoffDate}\n`;
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "debt_snowball_plan.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // --- CALENDAR FUNCTIONS ---
        const renderPaydayCalendar = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const today = new Date();
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();

            currentMonthYearEl.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            calendarGridEl.innerHTML = '';

            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-sm font-semibold text-gray-600';
                dayHeader.textContent = day;
                calendarGridEl.appendChild(dayHeader);
            });

            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                calendarGridEl.appendChild(emptyDay);
            }

            const paydays = getPaydaysForMonth(year, month);
            let upcomingPaydaysHtml = '';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'p-2 rounded-xl text-center text-gray-800';
                
                const dayDate = new Date(year, month, day);
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;

                if (isToday) {
                    dayEl.classList.add('bg-blue-200', 'font-bold');
                }

                if (paydays[day] && paydays[day].length > 0) {
                    dayEl.classList.add('bg-green-500', 'text-white', 'font-bold', 'shadow-md');
                    paydays[day].forEach(income => {
                        upcomingPaydaysHtml += `<li>${dayDate.toLocaleDateString()} - ${income.description}: ${formatCurrency(income.amount)}</li>`;
                    });
                } else if (dayDate.getDay() === 0 || dayDate.getDay() === 6) {
                    dayEl.classList.add('bg-gray-200');
                } else {
                    dayEl.classList.add('bg-white');
                }
                
                dayEl.textContent = day;
                calendarGridEl.appendChild(dayEl);
            }
            upcomingPaydaysListEl.innerHTML = upcomingPaydaysHtml || '<li>No upcoming paydays this month.</li>';
        };

        const getPaydaysForMonth = (year, month) => {
            const paydays = {};
            
            transactions.filter(t => t.type === 'income' && t.recurrence !== 'none').forEach(income => {
                if (!income.nextPayDate) return;

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);

                let currentDate = getPaydayDateInTimeZone(income.nextPayDate, income.timeZone);

                while (currentDate.getFullYear() < year || (currentDate.getFullYear() === year && currentDate.getMonth() < month)) {
                    if (income.recurrence === 'weekly') {
                        currentDate.setDate(currentDate.getDate() + 7);
                    } else if (income.recurrence === 'biweekly') {
                        currentDate.setDate(currentDate.getDate() + 14);
                    } else if (income.recurrence === 'monthly') {
                        let newMonth = currentDate.getMonth() + 1;
                        let newYear = currentDate.getFullYear();
                        currentDate = new Date(newYear, newMonth, Math.min(parseInt(income.monthlyDay), new Date(newYear, newMonth + 1, 0).getDate()));
                    }
                }
                
                while (currentDate.getFullYear() === year && currentDate.getMonth() === month) {
                    const day = currentDate.getDate();
                    if (!paydays[day]) {
                        paydays[day] = [];
                    }
                    paydays[day].push(income);

                    if (income.recurrence === 'weekly') {
                        currentDate.setDate(currentDate.getDate() + 7);
                    } else if (income.recurrence === 'biweekly') {
                        currentDate.setDate(currentDate.getDate() + 14);
                    } else if (income.recurrence === 'monthly') {
                        let newMonth = currentDate.getMonth() + 1;
                        let newYear = currentDate.getFullYear();
                        currentDate = new Date(newYear, newMonth, Math.min(parseInt(income.monthlyDay), new Date(newYear, newMonth + 1, 0).getDate()));
                    }
                }
            });
            return paydays;
        };

        // --- TIME ZONE FUNCTIONS ---
        const populateTimezoneSelector = () => {
            const timezones = Intl.supportedValuesOf('timeZone');
            const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            timezones.forEach(tz => {
                const option = document.createElement('option');
                option.value = tz;
                option.textContent = tz;
                timezoneSelect.appendChild(option);
            });
            
            timezoneSelect.value = userTimeZone;
        };

        // --- TAB NAVIGATION FUNCTIONALITY ---
        const showPage = (pageId) => {
            pageContainers.forEach(container => {
                container.classList.add('hidden');
            });
            tabButtons.forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800');
            });

            document.getElementById(pageId).classList.remove('hidden');
            document.querySelector(`[data-page="${pageId.replace('-page', '')}"]`).classList.add('bg-indigo-600', 'text-white');
            document.querySelector(`[data-page="${pageId.replace('-page', '')}"]`).classList.remove('bg-gray-200', 'text-gray-800');

            if (pageId === 'calendar-page') {
                renderPaydayCalendar(currentCalendarDate);
            }
        };

        // --- EVENT LISTENERS ---
        loginBtn.addEventListener('click', handleLogin);
        showSignupBtn.addEventListener('click', showSignupForm);
        createAccountBtn.addEventListener('click', handleSignup);
        backToLoginBtn.addEventListener('click', showLoginForm);
        logoutBtn.addEventListener('click', () => signOut(auth));

        typeSelect.addEventListener('change', () => {
            toggleDebtFields();
            toggleRecurrenceFields();
        });
        recurrenceSelect.addEventListener('change', toggleRecurrenceFields);
        transactionForm.addEventListener('submit', saveTransaction);
        saveTransactionBtn.addEventListener('click', saveTransaction);
        deleteTransactionBtn.addEventListener('click', deleteTransaction);
        cancelEditBtn.addEventListener('click', resetForm);
        calculateSnowballBtn.addEventListener('click', calculateSnowball);
        downloadSnowballBtn.addEventListener('click', exportSnowballPlan);

        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderPaydayCalendar(currentCalendarDate);
        });
        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderPaydayCalendar(currentCalendarDate);
        });

        tabButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const pageId = e.target.dataset.page;
                showPage(`${pageId}-page`);
            });
        });

        populateTimezoneSelector();

        // --- FIREBASE AUTH STATE CHANGE HANDLER ---
        const handleAuthChange = async (user) => {
            if (user) {
                userId = user.uid;
                userIdEl.textContent = userId;
                authSection.classList.add('hidden');
                trackerSection.classList.remove('hidden');

                if (unsubscribeFromTransactions) {
                    unsubscribeFromTransactions();
                }

                const q = query(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
                unsubscribeFromTransactions = onSnapshot(q, async (querySnapshot) => {
                    transactions = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    await processRecurringIncome(transactions);

                    updateSummary();
                    renderTransactions();
                    renderPaydayCalendar(currentCalendarDate);
                });

            } else {
                userId = '';
                authSection.classList.remove('hidden');
                trackerSection.classList.add('hidden');
                transactions = [];
                updateSummary();
                renderTransactions();
                renderPaydayCalendar(currentCalendarDate);
            }
        };

        onAuthStateChanged(auth, handleAuthChange);
    </script>
</body>
</html>
